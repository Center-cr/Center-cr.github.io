<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>hc05模块 | Center-cr's Blog</title><meta name="author" content="Center-cr"><meta name="copyright" content="Center-cr"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="hc05，usart中断配置 [stm32入门教程][STM32实战项目]STM32智能小车教程-循迹-避障-蓝牙遥控-跟随-stm32f103c8t6-stm32最小系统-手把手入门教程_哔哩哔哩_bilibili 首先进行AT指令调整波特率 main 12345678910111213141516171819202122232425262728293031323334353637383">
<meta property="og:type" content="article">
<meta property="og:title" content="hc05模块">
<meta property="og:url" content="http://example.com/2023/04/25/%E5%8D%95%E7%89%87%E6%9C%BA/HC05%E8%93%9D%E7%89%99%E6%8E%A7%E5%88%B6%E7%88%AC%E8%A1%8C%E6%9C%BA%E5%99%A8%E4%BA%BA/index.html">
<meta property="og:site_name" content="Center-cr&#39;s Blog">
<meta property="og:description" content="hc05，usart中断配置 [stm32入门教程][STM32实战项目]STM32智能小车教程-循迹-避障-蓝牙遥控-跟随-stm32f103c8t6-stm32最小系统-手把手入门教程_哔哩哔哩_bilibili 首先进行AT指令调整波特率 main 12345678910111213141516171819202122232425262728293031323334353637383">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Center-cr/picture/main/202307091524065.png">
<meta property="article:published_time" content="2023-04-24T16:00:00.000Z">
<meta property="article:modified_time" content="2023-06-30T16:00:00.000Z">
<meta property="article:author" content="Center-cr">
<meta property="article:tag" content="hc05">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Center-cr/picture/main/202307091524065.png"><link rel="shortcut icon" href="/img/icon.png"><link rel="canonical" href="http://example.com/2023/04/25/%E5%8D%95%E7%89%87%E6%9C%BA/HC05%E8%93%9D%E7%89%99%E6%8E%A7%E5%88%B6%E7%88%AC%E8%A1%8C%E6%9C%BA%E5%99%A8%E4%BA%BA/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.min.js',
      css: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'hc05模块',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-07-01 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/icon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">100</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">47</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/tools_online/"><i class="fa-fw fas fa-cloud"></i><span> 在线工具</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/Center-cr/picture/main/202307091524065.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Center-cr's Blog"><span class="site-name">Center-cr's Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/tools_online/"><i class="fa-fw fas fa-cloud"></i><span> 在线工具</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">hc05模块</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-24T16:00:00.000Z" title="发表于 2023-04-25 00:00:00">2023-04-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-30T16:00:00.000Z" title="更新于 2023-07-01 00:00:00">2023-07-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%8D%95%E7%89%87%E6%9C%BA/">单片机</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>40分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="hc05模块"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>hc05，usart中断配置</p>
<p>[<a
target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1SY411L7rJ/?spm_id_from=333.999.0.0&amp;vd_source=02db1c625d35cb658b463558f61202bc">stm32入门教程][STM32实战项目]STM32智能小车教程-循迹-避障-蓝牙遥控-跟随-stm32f103c8t6-stm32最小系统-手把手入门教程_哔哩哔哩_bilibili</a></p>
<h2 id="首先进行at指令调整波特率">首先进行AT指令调整波特率</h2>
<h2 id="main">main</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usart.h&quot;</span>		</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;delay.h&quot;</span>	</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;led.h&quot;</span>   </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;key.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usart2.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hc05.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;bsp_PCA9685.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">stand</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   setAngle(<span class="number">0</span>,<span class="number">120</span>);</span><br><span class="line">	delay_ms(<span class="number">20</span>);</span><br><span class="line">	setAngle(<span class="number">1</span>,<span class="number">170</span>);</span><br><span class="line">	delay_ms(<span class="number">20</span>);</span><br><span class="line">	setAngle(<span class="number">2</span>,<span class="number">15</span>);</span><br><span class="line">	delay_ms(<span class="number">20</span>);</span><br><span class="line">	setAngle(<span class="number">8</span>,<span class="number">135</span>);</span><br><span class="line">	delay_ms(<span class="number">20</span>);</span><br><span class="line">	setAngle(<span class="number">4</span>,<span class="number">90</span>);</span><br><span class="line">	delay_ms(<span class="number">20</span>);</span><br><span class="line">	setAngle(<span class="number">5</span>,<span class="number">90</span>);</span><br><span class="line">	delay_ms(<span class="number">20</span>);</span><br><span class="line">	setAngle(<span class="number">6</span>,<span class="number">85</span>);</span><br><span class="line">	delay_ms(<span class="number">20</span>);</span><br><span class="line">	setAngle(<span class="number">7</span>,<span class="number">88</span>);</span><br><span class="line">	delay_ms(<span class="number">20</span>);</span><br><span class="line">	setAngle(<span class="number">9</span>,<span class="number">55</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">change</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	setAngle(<span class="number">1</span>,<span class="number">136</span>),setAngle(<span class="number">8</span>,<span class="number">101</span>);<span class="comment">/*两脚抬起*/</span></span><br><span class="line">	delay_ms(<span class="number">500</span>);</span><br><span class="line">		</span><br><span class="line">	setAngle(<span class="number">4</span>,<span class="number">120</span>),setAngle(<span class="number">5</span>,<span class="number">60</span>);<span class="comment">/*两腿前进*/</span></span><br><span class="line">	delay_ms(<span class="number">500</span>);</span><br><span class="line">	</span><br><span class="line">	setAngle(<span class="number">1</span>,<span class="number">170</span>),setAngle(<span class="number">8</span>,<span class="number">135</span>);<span class="comment">/*两脚落下*/</span></span><br><span class="line">	delay_ms(<span class="number">500</span>);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">forward</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	setAngle(<span class="number">4</span>,<span class="number">90</span>),setAngle(<span class="number">5</span>,<span class="number">90</span>);<span class="comment">/*两腿复原*/</span></span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	setAngle(<span class="number">2</span>,<span class="number">49</span>),setAngle(<span class="number">0</span>,<span class="number">154</span>);<span class="comment">/*两脚抬起*/</span></span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	setAngle(<span class="number">6</span>,<span class="number">115</span>),setAngle(<span class="number">7</span>,<span class="number">58</span>);<span class="comment">/*两腿前进*/</span></span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	setAngle(<span class="number">0</span>,<span class="number">120</span>),setAngle(<span class="number">2</span>,<span class="number">15</span>);<span class="comment">/*两脚落下*/</span></span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	setAngle(<span class="number">6</span>,<span class="number">85</span>),setAngle(<span class="number">7</span>,<span class="number">88</span>);<span class="comment">/*两腿复原*/</span></span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	setAngle(<span class="number">1</span>,<span class="number">136</span>),setAngle(<span class="number">8</span>,<span class="number">101</span>);<span class="comment">/*两脚抬起*/</span></span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	setAngle(<span class="number">4</span>,<span class="number">120</span>),setAngle(<span class="number">5</span>,<span class="number">60</span>);<span class="comment">/*两腿前进*/</span></span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	setAngle(<span class="number">1</span>,<span class="number">170</span>),setAngle(<span class="number">8</span>,<span class="number">135</span>);<span class="comment">/*两脚落下*/</span></span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">leftavertance</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	setAngle(<span class="number">4</span>,<span class="number">110</span>),setAngle(<span class="number">5</span>,<span class="number">35</span>);</span><br><span class="line">	setAngle(<span class="number">2</span>,<span class="number">39</span>),setAngle(<span class="number">0</span>,<span class="number">149</span>);</span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	</span><br><span class="line">	setAngle(<span class="number">6</span>,<span class="number">53</span>),setAngle(<span class="number">7</span>,<span class="number">43</span>);</span><br><span class="line">	setAngle(<span class="number">0</span>,<span class="number">115</span>),setAngle(<span class="number">2</span>,<span class="number">5</span>);</span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line">	setAngle(<span class="number">1</span>,<span class="number">141</span>),setAngle(<span class="number">8</span>,<span class="number">106</span>);</span><br><span class="line">	setAngle(<span class="number">6</span>,<span class="number">23</span>),setAngle(<span class="number">7</span>,<span class="number">88</span>);</span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	</span><br><span class="line">	setAngle(<span class="number">4</span>,<span class="number">140</span>),setAngle(<span class="number">5</span>,<span class="number">5</span>);</span><br><span class="line">	setAngle(<span class="number">1</span>,<span class="number">175</span>),setAngle(<span class="number">8</span>,<span class="number">140</span>);</span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">rightavertance</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	setAngle(<span class="number">4</span>,<span class="number">110</span>),setAngle(<span class="number">5</span>,<span class="number">35</span>);</span><br><span class="line">	setAngle(<span class="number">2</span>,<span class="number">39</span>),setAngle(<span class="number">0</span>,<span class="number">149</span>);</span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	</span><br><span class="line">	setAngle(<span class="number">6</span>,<span class="number">53</span>),setAngle(<span class="number">7</span>,<span class="number">58</span>);</span><br><span class="line">	setAngle(<span class="number">0</span>,<span class="number">115</span>),setAngle(<span class="number">2</span>,<span class="number">5</span>);</span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line">	setAngle(<span class="number">1</span>,<span class="number">141</span>),setAngle(<span class="number">8</span>,<span class="number">106</span>);</span><br><span class="line">	setAngle(<span class="number">6</span>,<span class="number">23</span>),setAngle(<span class="number">7</span>,<span class="number">88</span>);</span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	</span><br><span class="line">	setAngle(<span class="number">4</span>,<span class="number">130</span>),setAngle(<span class="number">5</span>,<span class="number">15</span>);</span><br><span class="line">	setAngle(<span class="number">1</span>,<span class="number">175</span>),setAngle(<span class="number">8</span>,<span class="number">140</span>);</span><br><span class="line">	delay_ms(<span class="number">400</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">turnleft</span><span class="params">()</span></span><br><span class="line">&#123;		</span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">	  setAngle(<span class="number">0</span>,<span class="number">154</span>),setAngle(<span class="number">2</span>,<span class="number">49</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">6</span>,<span class="number">130</span>),setAngle(<span class="number">7</span>,<span class="number">133</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">0</span>,<span class="number">120</span>),setAngle(<span class="number">2</span>,<span class="number">15</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">1</span>,<span class="number">136</span>),setAngle(<span class="number">8</span>,<span class="number">101</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">6</span>,<span class="number">85</span>),setAngle(<span class="number">7</span>,<span class="number">88</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">1</span>,<span class="number">170</span>),setAngle(<span class="number">8</span>,<span class="number">135</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">turnright</span><span class="params">()</span></span><br><span class="line">&#123;		</span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">	  setAngle(<span class="number">0</span>,<span class="number">154</span>),setAngle(<span class="number">2</span>,<span class="number">49</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">6</span>,<span class="number">40</span>),setAngle(<span class="number">7</span>,<span class="number">43</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">0</span>,<span class="number">120</span>),setAngle(<span class="number">2</span>,<span class="number">15</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">1</span>,<span class="number">136</span>),setAngle(<span class="number">8</span>,<span class="number">101</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">6</span>,<span class="number">85</span>),setAngle(<span class="number">7</span>,<span class="number">88</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		setAngle(<span class="number">1</span>,<span class="number">170</span>),setAngle(<span class="number">8</span>,<span class="number">135</span>);</span><br><span class="line">		delay_ms(<span class="number">500</span>);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> g_usart2_flag = <span class="number">0</span>;</span><br><span class="line">u16 USART2_RX_STA=<span class="number">0</span>;   	</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;								  </span><br><span class="line">	u8 c5;</span><br><span class="line"><span class="comment">//	u8 key=0;</span></span><br><span class="line"><span class="comment">//	u8 sendcnt=0;</span></span><br><span class="line"><span class="comment">//	u8 sendbuf[20];	  </span></span><br><span class="line"><span class="comment">//	u8 reclen=0;  </span></span><br><span class="line">  Stm32_Clock_Init(<span class="number">9</span>);	<span class="comment">//系统时钟设置</span></span><br><span class="line">	delay_init(<span class="number">72</span>);			<span class="comment">//延时初始化</span></span><br><span class="line">	uart_init(<span class="number">72</span>,<span class="number">9600</span>); 	<span class="comment">//串口1初始化为9600</span></span><br><span class="line">	LED_Init();				<span class="comment">//初始化与LED连接的硬件接口</span></span><br><span class="line">	KEY_Init();				<span class="comment">//初始化按键</span></span><br><span class="line">	PCA9685_Init(<span class="number">60</span>,<span class="number">90</span>);<span class="comment">//舵机控制芯片初始化</span></span><br><span class="line">	c5=<span class="number">5</span>;</span><br><span class="line">	LED0=<span class="number">0</span>;					<span class="comment">//先点亮红灯</span></span><br><span class="line"><span class="keyword">while</span>(HC05_Init()) 		<span class="comment">//初始化ATK-HC05模块  </span></span><br><span class="line">	&#123;</span><br><span class="line">		;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">while</span>(c5)</span><br><span class="line">&#123;</span><br><span class="line">	c5--;</span><br><span class="line">	LED0=<span class="number">1</span>;		</span><br><span class="line">	delay_ms(<span class="number">500</span>);</span><br><span class="line">	LED0=<span class="number">0</span>;<span class="comment">//蓝牙成功初始化后红灯闪烁</span></span><br><span class="line">	delay_ms(<span class="number">500</span>);</span><br><span class="line">	u2_printf(<span class="string">&quot;Ready! \r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) </span><br><span class="line">	&#123;		</span><br><span class="line">		</span><br><span class="line">		forward();</span><br><span class="line"><span class="comment">//		if(g_usart2_flag ==0)</span></span><br><span class="line"><span class="comment">//		&#123;</span></span><br><span class="line"><span class="comment">//			forward();</span></span><br><span class="line"><span class="comment">//		</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//		else if(g_usart2_flag ==1)</span></span><br><span class="line"><span class="comment">//		&#123;</span></span><br><span class="line"><span class="comment">//				LED1 = 1;</span></span><br><span class="line"><span class="comment">////				u2_printf(&quot;111&quot;);</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//		else if(g_usart2_flag ==2)</span></span><br><span class="line"><span class="comment">//		&#123;</span></span><br><span class="line"><span class="comment">//				LED1 = 0;</span></span><br><span class="line"><span class="comment">////				u2_printf(&quot;yes&quot;);</span></span><br><span class="line"><span class="comment">////				delay_ms(300);</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//		else</span></span><br><span class="line"><span class="comment">//		&#123;</span></span><br><span class="line"><span class="comment">////						u2_printf(&quot;yes2&quot;);</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line">	&#125;		</span><br><span class="line">		    </span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">USART2_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	 u8 res;	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(USART2-&gt;SR&amp;(<span class="number">1</span>&lt;&lt;<span class="number">5</span>))<span class="comment">//接收到数据</span></span><br><span class="line">	&#123;	 </span><br><span class="line">		res=USART2-&gt;DR; 		</span><br><span class="line">		<span class="keyword">if</span>(res == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	</span><br><span class="line">		g_usart2_flag = <span class="number">0</span>;</span><br><span class="line">		forward();</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="keyword">if</span>(res == <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		g_usart2_flag = <span class="number">1</span>;</span><br><span class="line">		LED1 = <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">			<span class="keyword">if</span>(res == <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	</span><br><span class="line">		g_usart2_flag = <span class="number">2</span>;</span><br><span class="line">		LED1 = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">			<span class="keyword">if</span>(res == <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	</span><br><span class="line">		g_usart2_flag = <span class="number">3</span>;</span><br><span class="line">		LED0= <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="keyword">if</span>(res == <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	</span><br><span class="line">		g_usart2_flag = <span class="number">4</span>;</span><br><span class="line">		LED0= <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">			<span class="keyword">if</span>(res == <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	</span><br><span class="line">		g_usart2_flag = <span class="number">5</span>;</span><br><span class="line">		turnleft();</span><br><span class="line">		</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="keyword">if</span>(USART2_RX_STA&lt;USART2_MAX_RECV_LEN)		<span class="comment">//还可以接收数据</span></span><br><span class="line">		&#123;</span><br><span class="line">			TIM4-&gt;CNT=<span class="number">0</span>;         					<span class="comment">//计数器清空</span></span><br><span class="line">			<span class="keyword">if</span>(USART2_RX_STA==<span class="number">0</span>)TIM4_Set(<span class="number">1</span>);	 	<span class="comment">//使能定时器4的中断 </span></span><br><span class="line">			USART2_RX_BUF[USART2_RX_STA++]=res;		<span class="comment">//记录接收到的值	 </span></span><br><span class="line">		&#125;<span class="keyword">else</span> </span><br><span class="line">		&#123;</span><br><span class="line">			USART2_RX_STA|=<span class="number">1</span>&lt;&lt;<span class="number">15</span>;					<span class="comment">//强制标记接收完成</span></span><br><span class="line">		&#125; </span><br><span class="line">	&#125;  											 </span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="sys">sys</h2>
<h3 id="sys.c">sys.c</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span> </span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//系统时钟初始化（适合STM32F10x系列）		   </span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//创建日期:2010/1/1</span></span><br><span class="line"><span class="comment">//版本：V1.9</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved</span></span><br><span class="line"><span class="comment">//********************************************************************************</span></span><br><span class="line"><span class="comment">//V1.4修改说明</span></span><br><span class="line"><span class="comment">//把NVIC KO了,没有使用任何库文件!</span></span><br><span class="line"><span class="comment">//加入了JTAG_Set函数</span></span><br><span class="line"><span class="comment">//V1.5 20120322</span></span><br><span class="line"><span class="comment">//增加void INTX_DISABLE(void)和void INTX_ENABLE(void)两个函数</span></span><br><span class="line"><span class="comment">//V1.6 20120412</span></span><br><span class="line"><span class="comment">//1,增加MSR_MSP函数												    </span></span><br><span class="line"><span class="comment">//2,修改VECT_TAB_RAM的默认偏移,设置为0.</span></span><br><span class="line"><span class="comment">//V1.7 20120818</span></span><br><span class="line"><span class="comment">//1,添加ucos支持配置宏SYSTEM_SUPPORT_UCOS</span></span><br><span class="line"><span class="comment">//2,修改了注释</span></span><br><span class="line"><span class="comment">//3,去掉了不常用函数BKP_Write</span></span><br><span class="line"><span class="comment">//V1.8 20131120</span></span><br><span class="line"><span class="comment">//1,修改头文件为stm32f10x.h,不再使用stm32f10x_lib.h及其相关头文件</span></span><br><span class="line"><span class="comment">//V1.9 20150109</span></span><br><span class="line"><span class="comment">//1,修改头文件为MY_NVIC_Init函数部分代码以支持向量号大于63的中断的设置</span></span><br><span class="line"><span class="comment">//2,修改WFI_SET/INTX_DISABLE/INTX_ENABLE等函数的实现方式</span></span><br><span class="line"><span class="comment">//V2.0 20150322</span></span><br><span class="line"><span class="comment">//修改SYSTEM_SUPPORT_UCOS为SYSTEM_SUPPORT_OS</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置向量表偏移地址</span></span><br><span class="line"><span class="comment">//NVIC_VectTab:基址</span></span><br><span class="line"><span class="comment">//Offset:偏移量			 </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MY_NVIC_SetVectorTable</span><span class="params">(u32 NVIC_VectTab, u32 Offset)</span>	 </span><br><span class="line">&#123; 	   	 </span><br><span class="line">	SCB-&gt;VTOR = NVIC_VectTab|(Offset &amp; (u32)<span class="number">0x1FFFFF80</span>);<span class="comment">//设置NVIC的向量表偏移寄存器</span></span><br><span class="line">	<span class="comment">//用于标识向量表是在CODE区还是在RAM区</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//设置NVIC分组</span></span><br><span class="line"><span class="comment">//NVIC_Group:NVIC分组 0~4 总共5组 		   </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MY_NVIC_PriorityGroupConfig</span><span class="params">(u8 NVIC_Group)</span>	 </span><br><span class="line">&#123; </span><br><span class="line">	u32 temp,temp1;	  </span><br><span class="line">	temp1=(~NVIC_Group)&amp;<span class="number">0x07</span>;<span class="comment">//取后三位</span></span><br><span class="line">	temp1&lt;&lt;=<span class="number">8</span>;</span><br><span class="line">	temp=SCB-&gt;AIRCR;  <span class="comment">//读取先前的设置</span></span><br><span class="line">	temp&amp;=<span class="number">0X0000F8FF</span>; <span class="comment">//清空先前分组</span></span><br><span class="line">	temp|=<span class="number">0X05FA0000</span>; <span class="comment">//写入钥匙</span></span><br><span class="line">	temp|=temp1;	   </span><br><span class="line">	SCB-&gt;AIRCR=temp;  <span class="comment">//设置分组	    	  				   </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//设置NVIC </span></span><br><span class="line"><span class="comment">//NVIC_PreemptionPriority:抢占优先级</span></span><br><span class="line"><span class="comment">//NVIC_SubPriority       :响应优先级</span></span><br><span class="line"><span class="comment">//NVIC_Channel           :中断编号</span></span><br><span class="line"><span class="comment">//NVIC_Group             :中断分组 0~4</span></span><br><span class="line"><span class="comment">//注意优先级不能超过设定的组的范围!否则会有意想不到的错误</span></span><br><span class="line"><span class="comment">//组划分:</span></span><br><span class="line"><span class="comment">//组0:0位抢占优先级,4位响应优先级</span></span><br><span class="line"><span class="comment">//组1:1位抢占优先级,3位响应优先级</span></span><br><span class="line"><span class="comment">//组2:2位抢占优先级,2位响应优先级</span></span><br><span class="line"><span class="comment">//组3:3位抢占优先级,1位响应优先级</span></span><br><span class="line"><span class="comment">//组4:4位抢占优先级,0位响应优先级</span></span><br><span class="line"><span class="comment">//NVIC_SubPriority和NVIC_PreemptionPriority的原则是,数值越小,越优先	   </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MY_NVIC_Init</span><span class="params">(u8 NVIC_PreemptionPriority,u8 NVIC_SubPriority,u8 NVIC_Channel,u8 NVIC_Group)</span>	 </span><br><span class="line">&#123; </span><br><span class="line">	u32 temp;	</span><br><span class="line">	MY_NVIC_PriorityGroupConfig(NVIC_Group);<span class="comment">//设置分组</span></span><br><span class="line">	temp=NVIC_PreemptionPriority&lt;&lt;(<span class="number">4</span>-NVIC_Group);	  </span><br><span class="line">	temp|=NVIC_SubPriority&amp;(<span class="number">0x0f</span>&gt;&gt;NVIC_Group);</span><br><span class="line">	temp&amp;=<span class="number">0xf</span>;								<span class="comment">//取低四位  </span></span><br><span class="line">	NVIC-&gt;ISER[NVIC_Channel/<span class="number">32</span>]|=(<span class="number">1</span>&lt;&lt;NVIC_Channel%<span class="number">32</span>);<span class="comment">//使能中断位(要清除的话,相反操作就OK) </span></span><br><span class="line">	NVIC-&gt;IP[NVIC_Channel]|=temp&lt;&lt;<span class="number">4</span>;		<span class="comment">//设置响应优先级和抢断优先级   	    	  				   </span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//外部中断配置函数</span></span><br><span class="line"><span class="comment">//只针对GPIOA~G;不包括PVD,RTC和USB唤醒这三个</span></span><br><span class="line"><span class="comment">//参数:</span></span><br><span class="line"><span class="comment">//GPIOx:0~6,代表GPIOA~G</span></span><br><span class="line"><span class="comment">//BITx:需要使能的位;</span></span><br><span class="line"><span class="comment">//TRIM:触发模式,1,下升沿;2,上降沿;3，任意电平触发</span></span><br><span class="line"><span class="comment">//该函数一次只能配置1个IO口,多个IO口,需多次调用</span></span><br><span class="line"><span class="comment">//该函数会自动开启对应中断,以及屏蔽线   	    </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Ex_NVIC_Config</span><span class="params">(u8 GPIOx,u8 BITx,u8 TRIM)</span> </span><br><span class="line">&#123;</span><br><span class="line">	u8 EXTADDR;</span><br><span class="line">	u8 EXTOFFSET;</span><br><span class="line">	EXTADDR=BITx/<span class="number">4</span>;<span class="comment">//得到中断寄存器组的编号</span></span><br><span class="line">	EXTOFFSET=(BITx%<span class="number">4</span>)*<span class="number">4</span>; </span><br><span class="line">	RCC-&gt;APB2ENR|=<span class="number">0x01</span>;<span class="comment">//使能io复用时钟			 </span></span><br><span class="line">	AFIO-&gt;EXTICR[EXTADDR]&amp;=~(<span class="number">0x000F</span>&lt;&lt;EXTOFFSET);<span class="comment">//清除原来设置！！！</span></span><br><span class="line">	AFIO-&gt;EXTICR[EXTADDR]|=GPIOx&lt;&lt;EXTOFFSET;<span class="comment">//EXTI.BITx映射到GPIOx.BITx </span></span><br><span class="line">	<span class="comment">//自动设置</span></span><br><span class="line">	EXTI-&gt;IMR|=<span class="number">1</span>&lt;&lt;BITx;<span class="comment">//  开启line BITx上的中断</span></span><br><span class="line">	<span class="comment">//EXTI-&gt;EMR|=1&lt;&lt;BITx;//不屏蔽line BITx上的事件 (如果不屏蔽这句,在硬件上是可以的,但是在软件仿真的时候无法进入中断!)</span></span><br><span class="line"> 	<span class="keyword">if</span>(TRIM&amp;<span class="number">0x01</span>)EXTI-&gt;FTSR|=<span class="number">1</span>&lt;&lt;BITx;<span class="comment">//line BITx上事件下降沿触发</span></span><br><span class="line">	<span class="keyword">if</span>(TRIM&amp;<span class="number">0x02</span>)EXTI-&gt;RTSR|=<span class="number">1</span>&lt;&lt;BITx;<span class="comment">//line BITx上事件上升降沿触发</span></span><br><span class="line">&#125; 	  </span><br><span class="line"><span class="comment">//不能在这里执行所有外设复位!否则至少引起串口不工作.		    </span></span><br><span class="line"><span class="comment">//把所有时钟寄存器复位		  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MYRCC_DeInit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;	</span><br><span class="line"> 	RCC-&gt;APB1RSTR = <span class="number">0x00000000</span>;<span class="comment">//复位结束			 </span></span><br><span class="line">	RCC-&gt;APB2RSTR = <span class="number">0x00000000</span>; </span><br><span class="line">	  </span><br><span class="line">  	RCC-&gt;AHBENR = <span class="number">0x00000014</span>;  <span class="comment">//睡眠模式闪存和SRAM时钟使能.其他关闭.	  </span></span><br><span class="line">  	RCC-&gt;APB2ENR = <span class="number">0x00000000</span>; <span class="comment">//外设时钟关闭.			   </span></span><br><span class="line">  	RCC-&gt;APB1ENR = <span class="number">0x00000000</span>;   </span><br><span class="line">	RCC-&gt;CR |= <span class="number">0x00000001</span>;     <span class="comment">//使能内部高速时钟HSION	 															 </span></span><br><span class="line">	RCC-&gt;CFGR &amp;= <span class="number">0xF8FF0000</span>;   <span class="comment">//复位SW[1:0],HPRE[3:0],PPRE1[2:0],PPRE2[2:0],ADCPRE[1:0],MCO[2:0]					 </span></span><br><span class="line">	RCC-&gt;CR &amp;= <span class="number">0xFEF6FFFF</span>;     <span class="comment">//复位HSEON,CSSON,PLLON</span></span><br><span class="line">	RCC-&gt;CR &amp;= <span class="number">0xFFFBFFFF</span>;     <span class="comment">//复位HSEBYP	   	  </span></span><br><span class="line">	RCC-&gt;CFGR &amp;= <span class="number">0xFF80FFFF</span>;   <span class="comment">//复位PLLSRC, PLLXTPRE, PLLMUL[3:0] and USBPRE </span></span><br><span class="line">	RCC-&gt;CIR = <span class="number">0x00000000</span>;     <span class="comment">//关闭所有中断		 </span></span><br><span class="line">	<span class="comment">//配置向量表				  </span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>  VECT_TAB_RAM</span></span><br><span class="line">	MY_NVIC_SetVectorTable(<span class="number">0x20000000</span>, <span class="number">0x0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span>   </span></span><br><span class="line">	MY_NVIC_SetVectorTable(<span class="number">0x08000000</span>,<span class="number">0x0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//THUMB指令不支持汇编内联</span></span><br><span class="line"><span class="comment">//采用如下方法实现执行汇编指令WFI  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">WFI_SET</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__ASM <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;wfi&quot;</span>)</span>;		  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//关闭所有中断</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">INTX_DISABLE</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;		  </span><br><span class="line">	__ASM <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;cpsid i&quot;</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//开启所有中断</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">INTX_ENABLE</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__ASM <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;cpsie i&quot;</span>)</span>;		  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//设置栈顶地址</span></span><br><span class="line"><span class="comment">//addr:栈顶地址</span></span><br><span class="line">__asm <span class="type">void</span> <span class="title function_">MSR_MSP</span><span class="params">(u32 addr)</span> </span><br><span class="line">&#123;</span><br><span class="line">    MSR MSP, r0 			<span class="comment">//set Main Stack value</span></span><br><span class="line">    BX r14</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入待机模式	  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Sys_Standby</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	SCB-&gt;SCR|=<span class="number">1</span>&lt;&lt;<span class="number">2</span>;<span class="comment">//使能SLEEPDEEP位 (SYS-&gt;CTRL)	   </span></span><br><span class="line">  	RCC-&gt;APB1ENR|=<span class="number">1</span>&lt;&lt;<span class="number">28</span>;     <span class="comment">//使能电源时钟	    </span></span><br><span class="line"> 	PWR-&gt;CSR|=<span class="number">1</span>&lt;&lt;<span class="number">8</span>;          <span class="comment">//设置WKUP用于唤醒</span></span><br><span class="line">	PWR-&gt;CR|=<span class="number">1</span>&lt;&lt;<span class="number">2</span>;           <span class="comment">//清除Wake-up 标志</span></span><br><span class="line">	PWR-&gt;CR|=<span class="number">1</span>&lt;&lt;<span class="number">1</span>;           <span class="comment">//PDDS置位		  </span></span><br><span class="line">	WFI_SET();				 <span class="comment">//执行WFI指令		 </span></span><br><span class="line">&#125;	     </span><br><span class="line"><span class="comment">//系统软复位   </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Sys_Soft_Reset</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   </span><br><span class="line">	SCB-&gt;AIRCR =<span class="number">0X05FA0000</span>|(u32)<span class="number">0x04</span>;	  </span><br><span class="line">&#125; 		 </span><br><span class="line"><span class="comment">//JTAG模式设置,用于设置JTAG的模式</span></span><br><span class="line"><span class="comment">//mode:jtag,swd模式设置;00,全使能;01,使能SWD;10,全关闭;	   </span></span><br><span class="line"><span class="comment">//#define JTAG_SWD_DISABLE   0X02</span></span><br><span class="line"><span class="comment">//#define SWD_ENABLE         0X01</span></span><br><span class="line"><span class="comment">//#define JTAG_SWD_ENABLE    0X00		  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">JTAG_Set</span><span class="params">(u8 mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	u32 temp;</span><br><span class="line">	temp=mode;</span><br><span class="line">	temp&lt;&lt;=<span class="number">25</span>;</span><br><span class="line">	RCC-&gt;APB2ENR|=<span class="number">1</span>&lt;&lt;<span class="number">0</span>;     <span class="comment">//开启辅助时钟	   </span></span><br><span class="line">	AFIO-&gt;MAPR&amp;=<span class="number">0XF8FFFFFF</span>; <span class="comment">//清除MAPR的[26:24]</span></span><br><span class="line">	AFIO-&gt;MAPR|=temp;       <span class="comment">//设置jtag模式</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//系统时钟初始化函数</span></span><br><span class="line"><span class="comment">//pll:选择的倍频数，从2开始，最大值为16		 </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Stm32_Clock_Init</span><span class="params">(u8 PLL)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> temp=<span class="number">0</span>;   </span><br><span class="line">	MYRCC_DeInit();		  <span class="comment">//复位并配置向量表</span></span><br><span class="line"> 	RCC-&gt;CR|=<span class="number">0x00010000</span>;  <span class="comment">//外部高速时钟使能HSEON</span></span><br><span class="line">	<span class="keyword">while</span>(!(RCC-&gt;CR&gt;&gt;<span class="number">17</span>));<span class="comment">//等待外部时钟就绪</span></span><br><span class="line">	RCC-&gt;CFGR=<span class="number">0X00000400</span>; <span class="comment">//APB1=DIV2;APB2=DIV1;AHB=DIV1;</span></span><br><span class="line">	PLL-=<span class="number">2</span>;				  <span class="comment">//抵消2个单位（因为是从2开始的，设置0就是2）</span></span><br><span class="line">	RCC-&gt;CFGR|=PLL&lt;&lt;<span class="number">18</span>;   <span class="comment">//设置PLL值 2~16</span></span><br><span class="line">	RCC-&gt;CFGR|=<span class="number">1</span>&lt;&lt;<span class="number">16</span>;	  <span class="comment">//PLLSRC ON </span></span><br><span class="line">	FLASH-&gt;ACR|=<span class="number">0x32</span>;	  <span class="comment">//FLASH 2个延时周期</span></span><br><span class="line">	RCC-&gt;CR|=<span class="number">0x01000000</span>;  <span class="comment">//PLLON</span></span><br><span class="line">	<span class="keyword">while</span>(!(RCC-&gt;CR&gt;&gt;<span class="number">25</span>));<span class="comment">//等待PLL锁定</span></span><br><span class="line">	RCC-&gt;CFGR|=<span class="number">0x00000002</span>;<span class="comment">//PLL作为系统时钟	 </span></span><br><span class="line">	<span class="keyword">while</span>(temp!=<span class="number">0x02</span>)     <span class="comment">//等待PLL作为系统时钟设置成功</span></span><br><span class="line">	&#123;   </span><br><span class="line">		temp=RCC-&gt;CFGR&gt;&gt;<span class="number">2</span>;</span><br><span class="line">		temp&amp;=<span class="number">0x03</span>;</span><br><span class="line">	&#125;    </span><br><span class="line">&#125;		    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="sys.h">sys.h</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __SYS_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SYS_H	  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32f10x.h&quot;</span>  </span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//系统时钟初始化（适合STM32F10x系列）		   </span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//创建日期:2010/1/1</span></span><br><span class="line"><span class="comment">//版本：V1.9</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved</span></span><br><span class="line"><span class="comment">//********************************************************************************</span></span><br><span class="line"><span class="comment">//V1.4修改说明</span></span><br><span class="line"><span class="comment">//把NVIC KO了,没有使用任何库文件!</span></span><br><span class="line"><span class="comment">//加入了JTAG_Set函数</span></span><br><span class="line"><span class="comment">//V1.5 20120322</span></span><br><span class="line"><span class="comment">//增加void INTX_DISABLE(void)和void INTX_ENABLE(void)两个函数</span></span><br><span class="line"><span class="comment">//V1.6 20120412</span></span><br><span class="line"><span class="comment">//1,增加MSR_MSP函数												    </span></span><br><span class="line"><span class="comment">//2,修改VECT_TAB_RAM的默认偏移,设置为0.</span></span><br><span class="line"><span class="comment">//V1.7 20120818</span></span><br><span class="line"><span class="comment">//1,添加ucos支持配置宏SYSTEM_SUPPORT_UCOS</span></span><br><span class="line"><span class="comment">//2,修改了注释</span></span><br><span class="line"><span class="comment">//3,去掉了不常用函数BKP_Write</span></span><br><span class="line"><span class="comment">//V1.8 20131120</span></span><br><span class="line"><span class="comment">//1,修改头文件为stm32f10x.h,不再使用stm32f10x_lib.h及其相关头文件</span></span><br><span class="line"><span class="comment">//V1.9 20150109</span></span><br><span class="line"><span class="comment">//1,修改头文件为MY_NVIC_Init函数部分代码以支持向量号大于63的中断的设置</span></span><br><span class="line"><span class="comment">//2,修改WFI_SET/INTX_DISABLE/INTX_ENABLE等函数的实现方式</span></span><br><span class="line"><span class="comment">//V2.0 20150322</span></span><br><span class="line"><span class="comment">//修改SYSTEM_SUPPORT_UCOS为SYSTEM_SUPPORT_OS</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//0,不支持OS</span></span><br><span class="line"><span class="comment">//1,支持OS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYSTEM_SUPPORT_OS		0		<span class="comment">//定义系统文件夹是否支持OS</span></span></span><br><span class="line">																	    </span><br><span class="line">	 </span><br><span class="line"><span class="comment">//位带操作,实现51类似的GPIO控制功能</span></span><br><span class="line"><span class="comment">//具体实现思想,参考&lt;&lt;CM3权威指南&gt;&gt;第五章(87页~92页).</span></span><br><span class="line"><span class="comment">//IO口操作宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BITBAND(addr, bitnum) ((addr &amp; 0xF0000000)+0x2000000+((addr &amp;0xFFFFF)&lt;&lt;5)+(bitnum&lt;&lt;2)) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MEM_ADDR(addr)  *((volatile unsigned long  *)(addr)) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIT_ADDR(addr, bitnum)   MEM_ADDR(BITBAND(addr, bitnum)) </span></span><br><span class="line"><span class="comment">//IO口地址映射</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOA_ODR_Addr    (GPIOA_BASE+12) <span class="comment">//0x4001080C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOB_ODR_Addr    (GPIOB_BASE+12) <span class="comment">//0x40010C0C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOC_ODR_Addr    (GPIOC_BASE+12) <span class="comment">//0x4001100C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOD_ODR_Addr    (GPIOD_BASE+12) <span class="comment">//0x4001140C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOE_ODR_Addr    (GPIOE_BASE+12) <span class="comment">//0x4001180C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOF_ODR_Addr    (GPIOF_BASE+12) <span class="comment">//0x40011A0C    </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOG_ODR_Addr    (GPIOG_BASE+12) <span class="comment">//0x40011E0C    </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOA_IDR_Addr    (GPIOA_BASE+8) <span class="comment">//0x40010808 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOB_IDR_Addr    (GPIOB_BASE+8) <span class="comment">//0x40010C08 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOC_IDR_Addr    (GPIOC_BASE+8) <span class="comment">//0x40011008 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOD_IDR_Addr    (GPIOD_BASE+8) <span class="comment">//0x40011408 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOE_IDR_Addr    (GPIOE_BASE+8) <span class="comment">//0x40011808 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOF_IDR_Addr    (GPIOF_BASE+8) <span class="comment">//0x40011A08 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOG_IDR_Addr    (GPIOG_BASE+8) <span class="comment">//0x40011E08 </span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//IO口操作,只对单一的IO口!</span></span><br><span class="line"><span class="comment">//确保n的值小于16!</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAout(n)   BIT_ADDR(GPIOA_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAin(n)    BIT_ADDR(GPIOA_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PBout(n)   BIT_ADDR(GPIOB_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PBin(n)    BIT_ADDR(GPIOB_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCout(n)   BIT_ADDR(GPIOC_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCin(n)    BIT_ADDR(GPIOC_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDout(n)   BIT_ADDR(GPIOD_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDin(n)    BIT_ADDR(GPIOD_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEout(n)   BIT_ADDR(GPIOE_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEin(n)    BIT_ADDR(GPIOE_IDR_Addr,n)  <span class="comment">//输入</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFout(n)   BIT_ADDR(GPIOF_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFin(n)    BIT_ADDR(GPIOF_IDR_Addr,n)  <span class="comment">//输入</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGout(n)   BIT_ADDR(GPIOG_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGin(n)    BIT_ADDR(GPIOG_IDR_Addr,n)  <span class="comment">//输入</span></span></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//Ex_NVIC_Config专用定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_A 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_B 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_C 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_D 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_E 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_F 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIO_G 6 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FTIR   1  <span class="comment">//下降沿触发</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTIR   2  <span class="comment">//上升沿触发</span></span></span><br><span class="line">								   </span><br><span class="line"></span><br><span class="line"><span class="comment">//JTAG模式设置定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JTAG_SWD_DISABLE   0X02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWD_ENABLE         0X01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JTAG_SWD_ENABLE    0X00	</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Stm32_Clock_Init</span><span class="params">(u8 PLL)</span>;  <span class="comment">//时钟初始化  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Sys_Soft_Reset</span><span class="params">(<span class="type">void</span>)</span>;      <span class="comment">//系统软复位</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Sys_Standby</span><span class="params">(<span class="type">void</span>)</span>;         <span class="comment">//待机模式 	</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MY_NVIC_SetVectorTable</span><span class="params">(u32 NVIC_VectTab, u32 Offset)</span>;<span class="comment">//设置偏移地址</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MY_NVIC_PriorityGroupConfig</span><span class="params">(u8 NVIC_Group)</span>;<span class="comment">//设置NVIC分组</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MY_NVIC_Init</span><span class="params">(u8 NVIC_PreemptionPriority,u8 NVIC_SubPriority,u8 NVIC_Channel,u8 NVIC_Group)</span>;<span class="comment">//设置中断</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Ex_NVIC_Config</span><span class="params">(u8 GPIOx,u8 BITx,u8 TRIM)</span>;<span class="comment">//外部中断配置函数(只对GPIOA~G)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">JTAG_Set</span><span class="params">(u8 mode)</span>;</span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//以下为汇编函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">WFI_SET</span><span class="params">(<span class="type">void</span>)</span>;		<span class="comment">//执行WFI指令</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">INTX_DISABLE</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//关闭所有中断</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">INTX_ENABLE</span><span class="params">(<span class="type">void</span>)</span>;	<span class="comment">//开启所有中断</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MSR_MSP</span><span class="params">(u32 addr)</span>;	<span class="comment">//设置堆栈地址</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYSTEM_SUPPORT_OS		0		<span class="comment">//定义系统文件夹是否支持UCOS</span></span></span><br><span class="line">																	    </span><br><span class="line">	 </span><br><span class="line"><span class="comment">//位带操作,实现51类似的GPIO控制功能</span></span><br><span class="line"><span class="comment">//具体实现思想,参考&lt;&lt;CM3权威指南&gt;&gt;第五章(87页~92页).</span></span><br><span class="line"><span class="comment">//IO口操作宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BITBAND(addr, bitnum) ((addr &amp; 0xF0000000)+0x2000000+((addr &amp;0xFFFFF)&lt;&lt;5)+(bitnum&lt;&lt;2)) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MEM_ADDR(addr)  *((volatile unsigned long  *)(addr)) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIT_ADDR(addr, bitnum)   MEM_ADDR(BITBAND(addr, bitnum)) </span></span><br><span class="line"><span class="comment">//IO口地址映射</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOA_ODR_Addr    (GPIOA_BASE+12) <span class="comment">//0x4001080C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOB_ODR_Addr    (GPIOB_BASE+12) <span class="comment">//0x40010C0C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOC_ODR_Addr    (GPIOC_BASE+12) <span class="comment">//0x4001100C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOD_ODR_Addr    (GPIOD_BASE+12) <span class="comment">//0x4001140C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOE_ODR_Addr    (GPIOE_BASE+12) <span class="comment">//0x4001180C </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOF_ODR_Addr    (GPIOF_BASE+12) <span class="comment">//0x40011A0C    </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOG_ODR_Addr    (GPIOG_BASE+12) <span class="comment">//0x40011E0C    </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOA_IDR_Addr    (GPIOA_BASE+8) <span class="comment">//0x40010808 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOB_IDR_Addr    (GPIOB_BASE+8) <span class="comment">//0x40010C08 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOC_IDR_Addr    (GPIOC_BASE+8) <span class="comment">//0x40011008 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOD_IDR_Addr    (GPIOD_BASE+8) <span class="comment">//0x40011408 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOE_IDR_Addr    (GPIOE_BASE+8) <span class="comment">//0x40011808 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOF_IDR_Addr    (GPIOF_BASE+8) <span class="comment">//0x40011A08 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOG_IDR_Addr    (GPIOG_BASE+8) <span class="comment">//0x40011E08 </span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//IO口操作,只对单一的IO口!</span></span><br><span class="line"><span class="comment">//确保n的值小于16!</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAout(n)   BIT_ADDR(GPIOA_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAin(n)    BIT_ADDR(GPIOA_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PBout(n)   BIT_ADDR(GPIOB_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PBin(n)    BIT_ADDR(GPIOB_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCout(n)   BIT_ADDR(GPIOC_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCin(n)    BIT_ADDR(GPIOC_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDout(n)   BIT_ADDR(GPIOD_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDin(n)    BIT_ADDR(GPIOD_IDR_Addr,n)  <span class="comment">//输入 </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEout(n)   BIT_ADDR(GPIOE_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PEin(n)    BIT_ADDR(GPIOE_IDR_Addr,n)  <span class="comment">//输入</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFout(n)   BIT_ADDR(GPIOF_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFin(n)    BIT_ADDR(GPIOF_IDR_Addr,n)  <span class="comment">//输入</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGout(n)   BIT_ADDR(GPIOG_ODR_Addr,n)  <span class="comment">//输出 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGin(n)    BIT_ADDR(GPIOG_IDR_Addr,n)  <span class="comment">//输入</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下为汇编函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">WFI_SET</span><span class="params">(<span class="type">void</span>)</span>;		<span class="comment">//执行WFI指令</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">INTX_DISABLE</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">//关闭所有中断</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">INTX_ENABLE</span><span class="params">(<span class="type">void</span>)</span>;	<span class="comment">//开启所有中断</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MSR_MSP</span><span class="params">(u32 addr)</span>;	<span class="comment">//设置堆栈地址</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="usart">usart</h2>
<h3 id="usart.c">usart.c</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usart.h&quot;</span>	  </span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	 </span></span><br><span class="line"><span class="comment">//如果使用ucos,则包括下面的头文件即可.</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SYSTEM_SUPPORT_OS</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;includes.h&quot;</span>					<span class="comment">//ucos 使用	  </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//串口1初始化（适合STM32F10x系列）		   </span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//创建日期:2010/1/1</span></span><br><span class="line"><span class="comment">//版本：V1.7</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved</span></span><br><span class="line"><span class="comment">//********************************************************************************</span></span><br><span class="line"><span class="comment">//V1.3修改说明 </span></span><br><span class="line"><span class="comment">//支持适应不同频率下的串口波特率设置.</span></span><br><span class="line"><span class="comment">//加入了对printf的支持</span></span><br><span class="line"><span class="comment">//增加了串口接收命令功能.</span></span><br><span class="line"><span class="comment">//修正了printf第一个字符丢失的bug</span></span><br><span class="line"><span class="comment">//V1.4修改说明</span></span><br><span class="line"><span class="comment">//1,修改串口初始化IO的bug</span></span><br><span class="line"><span class="comment">//2,修改了USART_RX_STA,使得串口最大接收字节数为2的14次方</span></span><br><span class="line"><span class="comment">//3,增加了USART_REC_LEN,用于定义串口最大允许接收的字节数(不大于2的14次方)</span></span><br><span class="line"><span class="comment">//4,修改了EN_USART1_RX的使能方式</span></span><br><span class="line"><span class="comment">//V1.5修改说明</span></span><br><span class="line"><span class="comment">//1,增加了对UCOSII的支持</span></span><br><span class="line"><span class="comment">//V1.6修改说明 20150109</span></span><br><span class="line"><span class="comment">//uart_init函数去掉了开启PE中断</span></span><br><span class="line"><span class="comment">//V1.7修改说明 20150322</span></span><br><span class="line"><span class="comment">//修改OS_CRITICAL_METHOD宏判断为：SYSTEM_SUPPORT_OS</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	  </span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//加入以下代码,支持printf函数,而不需要选择use MicroLIB	  </span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> import(__use_no_semihosting)             </span></span><br><span class="line"><span class="comment">//标准库需要的支持函数                 </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">FILE</span> </span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">	<span class="type">int</span> handle; </span><br><span class="line">	<span class="comment">/* Whatever you require here. If the only file you are using is */</span> </span><br><span class="line">	<span class="comment">/* standard output using printf() for debugging, no file handling */</span> </span><br><span class="line">	<span class="comment">/* is required. */</span> </span><br><span class="line">&#125;; </span><br><span class="line"><span class="comment">/* FILE is typedef’ d in stdio.h. */</span> </span><br><span class="line">FILE __stdout;       </span><br><span class="line"><span class="comment">//定义_sys_exit()以避免使用半主机模式    </span></span><br><span class="line"><span class="type">void</span> _sys_exit(<span class="type">int</span> x) </span><br><span class="line">&#123; </span><br><span class="line">	x = x; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//重定向fputc函数</span></span><br><span class="line"><span class="comment">//printf的输出，指向fputc，由fputc输出到串口</span></span><br><span class="line"><span class="comment">//这里使用串口1(USART1)输出printf信息</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fputc</span><span class="params">(<span class="type">int</span> ch, FILE *f)</span></span><br><span class="line">&#123;      </span><br><span class="line">	<span class="keyword">while</span>((USART1-&gt;SR&amp;<span class="number">0X40</span>)==<span class="number">0</span>);<span class="comment">//等待上一次串口数据发送完成  </span></span><br><span class="line">	USART1-&gt;DR = (u8) ch;      	<span class="comment">//写DR,串口1将发送数据</span></span><br><span class="line">	<span class="keyword">return</span> ch;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line"><span class="comment">//end</span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> EN_USART1_RX   <span class="comment">//如果使能了接收</span></span></span><br><span class="line"><span class="comment">//串口1中断服务程序</span></span><br><span class="line"><span class="comment">//注意,读取USARTx-&gt;SR能避免莫名其妙的错误   	</span></span><br><span class="line">u8 USART_RX_BUF[USART_REC_LEN];     <span class="comment">//接收缓冲,最大USART_REC_LEN个字节.</span></span><br><span class="line"><span class="comment">//接收状态</span></span><br><span class="line"><span class="comment">//bit15，	接收完成标志</span></span><br><span class="line"><span class="comment">//bit14，	接收到0x0d</span></span><br><span class="line"><span class="comment">//bit13~0，	接收到的有效字节数目</span></span><br><span class="line">u16 USART_RX_STA=<span class="number">0</span>;       <span class="comment">//接收状态标记	  </span></span><br><span class="line">  </span><br><span class="line"><span class="type">void</span> <span class="title function_">USART1_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 res;	</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SYSTEM_SUPPORT_OS 		<span class="comment">//如果SYSTEM_SUPPORT_OS为真，则需要支持OS.</span></span></span><br><span class="line">	OSIntEnter();    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span>(USART1-&gt;SR&amp;(<span class="number">1</span>&lt;&lt;<span class="number">5</span>))	<span class="comment">//接收到数据</span></span><br><span class="line">	&#123;	 </span><br><span class="line">		res=USART1-&gt;DR; </span><br><span class="line">		<span class="keyword">if</span>((USART_RX_STA&amp;<span class="number">0x8000</span>)==<span class="number">0</span>)<span class="comment">//接收未完成</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(USART_RX_STA&amp;<span class="number">0x4000</span>)<span class="comment">//接收到了0x0d</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(res!=<span class="number">0x0a</span>)USART_RX_STA=<span class="number">0</span>;<span class="comment">//接收错误,重新开始</span></span><br><span class="line">				<span class="keyword">else</span> USART_RX_STA|=<span class="number">0x8000</span>;	<span class="comment">//接收完成了 </span></span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="comment">//还没收到0X0D</span></span><br><span class="line">			&#123;	</span><br><span class="line">				<span class="keyword">if</span>(res==<span class="number">0x0d</span>)USART_RX_STA|=<span class="number">0x4000</span>;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					USART_RX_BUF[USART_RX_STA&amp;<span class="number">0X3FFF</span>]=res;</span><br><span class="line">					USART_RX_STA++;</span><br><span class="line">					<span class="keyword">if</span>(USART_RX_STA&gt;(USART_REC_LEN<span class="number">-1</span>))USART_RX_STA=<span class="number">0</span>;<span class="comment">//接收数据错误,重新开始接收	  </span></span><br><span class="line">				&#125;		 </span><br><span class="line">			&#125;</span><br><span class="line">		&#125;  		 									     </span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SYSTEM_SUPPORT_OS 	<span class="comment">//如果SYSTEM_SUPPORT_OS为真，则需要支持OS.</span></span></span><br><span class="line">	OSIntExit();  											 </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>										 </span></span><br><span class="line"><span class="comment">//初始化IO 串口1</span></span><br><span class="line"><span class="comment">//pclk2:PCLK2时钟频率(Mhz)</span></span><br><span class="line"><span class="comment">//bound:波特率 </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_init</span><span class="params">(u32 pclk2,u32 bound)</span></span><br><span class="line">&#123;  	 </span><br><span class="line">	<span class="type">float</span> temp;</span><br><span class="line">	u16 mantissa;</span><br><span class="line">	u16 fraction;	   </span><br><span class="line">	temp=(<span class="type">float</span>)(pclk2*<span class="number">1000000</span>)/(bound*<span class="number">16</span>);<span class="comment">//得到USARTDIV</span></span><br><span class="line">	mantissa=temp;				 <span class="comment">//得到整数部分</span></span><br><span class="line">	fraction=(temp-mantissa)*<span class="number">16</span>; <span class="comment">//得到小数部分	 </span></span><br><span class="line">    mantissa&lt;&lt;=<span class="number">4</span>;</span><br><span class="line">	mantissa+=fraction; </span><br><span class="line">	RCC-&gt;APB2ENR|=<span class="number">1</span>&lt;&lt;<span class="number">2</span>;   <span class="comment">//使能PORTA口时钟  </span></span><br><span class="line">	RCC-&gt;APB2ENR|=<span class="number">1</span>&lt;&lt;<span class="number">14</span>;  <span class="comment">//使能串口时钟 </span></span><br><span class="line">	GPIOA-&gt;CRH&amp;=<span class="number">0XFFFFF00F</span>;<span class="comment">//IO状态设置</span></span><br><span class="line">	GPIOA-&gt;CRH|=<span class="number">0X000008B0</span>;<span class="comment">//IO状态设置 </span></span><br><span class="line">	RCC-&gt;APB2RSTR|=<span class="number">1</span>&lt;&lt;<span class="number">14</span>;   <span class="comment">//复位串口1</span></span><br><span class="line">	RCC-&gt;APB2RSTR&amp;=~(<span class="number">1</span>&lt;&lt;<span class="number">14</span>);<span class="comment">//停止复位	   	   </span></span><br><span class="line">	<span class="comment">//波特率设置</span></span><br><span class="line"> 	USART1-&gt;BRR=mantissa; <span class="comment">// 波特率设置	 </span></span><br><span class="line">	USART1-&gt;CR1|=<span class="number">0X200C</span>;  <span class="comment">//1位停止,无校验位.</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> EN_USART1_RX		  <span class="comment">//如果使能了接收</span></span></span><br><span class="line">	<span class="comment">//使能接收中断 </span></span><br><span class="line">	USART1-&gt;CR1|=<span class="number">1</span>&lt;&lt;<span class="number">5</span>;    <span class="comment">//接收缓冲区非空中断使能	    	</span></span><br><span class="line">	MY_NVIC_Init(<span class="number">3</span>,<span class="number">3</span>,USART1_IRQn,<span class="number">2</span>);<span class="comment">//组2，最低优先级 </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="usart.h">usart.h</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __USART_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __USART_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span>	 </span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//串口1初始化（适合STM32F10x系列）		   </span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//创建日期:2010/1/1</span></span><br><span class="line"><span class="comment">//版本：V1.7</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved</span></span><br><span class="line"><span class="comment">//********************************************************************************</span></span><br><span class="line"><span class="comment">//V1.3修改说明 </span></span><br><span class="line"><span class="comment">//支持适应不同频率下的串口波特率设置.</span></span><br><span class="line"><span class="comment">//加入了对printf的支持</span></span><br><span class="line"><span class="comment">//增加了串口接收命令功能.</span></span><br><span class="line"><span class="comment">//修正了printf第一个字符丢失的bug</span></span><br><span class="line"><span class="comment">//V1.4修改说明</span></span><br><span class="line"><span class="comment">//1,修改串口初始化IO的bug</span></span><br><span class="line"><span class="comment">//2,修改了USART_RX_STA,使得串口最大接收字节数为2的14次方</span></span><br><span class="line"><span class="comment">//3,增加了USART_REC_LEN,用于定义串口最大允许接收的字节数(不大于2的14次方)</span></span><br><span class="line"><span class="comment">//4,修改了EN_USART1_RX的使能方式</span></span><br><span class="line"><span class="comment">//V1.5修改说明</span></span><br><span class="line"><span class="comment">//1,增加了对UCOSII的支持</span></span><br><span class="line"><span class="comment">//V1.6修改说明 20150109</span></span><br><span class="line"><span class="comment">//uart_init函数去掉了开启PE中断</span></span><br><span class="line"><span class="comment">//V1.7修改说明 20150322</span></span><br><span class="line"><span class="comment">//修改OS_CRITICAL_METHOD宏判断为：SYSTEM_SUPPORT_OS</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	  </span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USART_REC_LEN  			200  	<span class="comment">//定义最大接收字节数 200</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EN_USART1_RX 			1		<span class="comment">//使能（1）/禁止（0）串口1接收</span></span></span><br><span class="line">	  	</span><br><span class="line"><span class="keyword">extern</span> u8  USART_RX_BUF[USART_REC_LEN]; <span class="comment">//接收缓冲,最大USART_REC_LEN个字节.末字节为换行符 </span></span><br><span class="line"><span class="keyword">extern</span> u16 USART_RX_STA;         		<span class="comment">//接收状态标记	</span></span><br><span class="line"><span class="comment">//如果想串口中断接收，请不要注释以下宏定义</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_init</span><span class="params">(u32 pclk2,u32 bound)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>	   </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="delay">delay</h2>
<h3 id="delay.c">delay.c</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	 </span></span><br><span class="line"><span class="comment">//如果需要使用OS,则包括下面的头文件即可.</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SYSTEM_SUPPORT_OS</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;includes.h&quot;</span>					<span class="comment">//ucos 使用	  </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//使用SysTick的普通计数模式对延迟进行管理（适合STM32F10x系列）</span></span><br><span class="line"><span class="comment">//包括delay_us,delay_ms</span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//创建日期:2010/1/1</span></span><br><span class="line"><span class="comment">//版本：V1.8</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved</span></span><br><span class="line"><span class="comment">//********************************************************************************</span></span><br><span class="line"><span class="comment">//V1.2修改说明</span></span><br><span class="line"><span class="comment">//修正了中断中调用出现死循环的错误</span></span><br><span class="line"><span class="comment">//防止延时不准确,采用do while结构!</span></span><br><span class="line"><span class="comment">//V1.3修改说明</span></span><br><span class="line"><span class="comment">//增加了对UCOSII延时的支持.</span></span><br><span class="line"><span class="comment">//如果使用ucosII,delay_init会自动设置SYSTICK的值,使之与ucos的TICKS_PER_SEC对应.</span></span><br><span class="line"><span class="comment">//delay_ms和delay_us也进行了针对ucos的改造.</span></span><br><span class="line"><span class="comment">//delay_us可以在ucos下使用,而且准确度很高,更重要的是没有占用额外的定时器.</span></span><br><span class="line"><span class="comment">//delay_ms在ucos下,可以当成OSTimeDly来用,在未启动ucos时,它采用delay_us实现,从而准确延时</span></span><br><span class="line"><span class="comment">//可以用来初始化外设,在启动了ucos之后delay_ms根据延时的长短,选择OSTimeDly实现或者delay_us实现.</span></span><br><span class="line"><span class="comment">//V1.4修改说明 20110929</span></span><br><span class="line"><span class="comment">//修改了使用ucos,但是ucos未启动的时候,delay_ms中中断无法响应的bug.</span></span><br><span class="line"><span class="comment">//V1.5修改说明 20120902</span></span><br><span class="line"><span class="comment">//在delay_us加入ucos上锁，防止由于ucos打断delay_us的执行，可能导致的延时不准。</span></span><br><span class="line"><span class="comment">//V1.6修改说明 20150109</span></span><br><span class="line"><span class="comment">//在delay_ms加入OSLockNesting判断。</span></span><br><span class="line"><span class="comment">//V1.7修改说明 20150319</span></span><br><span class="line"><span class="comment">//修改OS支持方式,以支持任意OS(不限于UCOSII和UCOSIII,理论上任意OS都可以支持)</span></span><br><span class="line"><span class="comment">//添加:delay_osrunning/delay_ostickspersec/delay_osintnesting三个宏定义</span></span><br><span class="line"><span class="comment">//添加:delay_osschedlock/delay_osschedunlock/delay_ostimedly三个函数</span></span><br><span class="line"><span class="comment">//V1.8修改说明 20150519</span></span><br><span class="line"><span class="comment">//修正UCOSIII支持时的2个bug：</span></span><br><span class="line"><span class="comment">//delay_tickspersec改为：delay_ostickspersec</span></span><br><span class="line"><span class="comment">//delay_intnesting改为：delay_osintnesting</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	 </span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> u8  fac_us=<span class="number">0</span>;							<span class="comment">//us延时倍乘数			   </span></span><br><span class="line"><span class="type">static</span> u16 fac_ms=<span class="number">0</span>;							<span class="comment">//ms延时倍乘数,在ucos下,代表每个节拍的ms数</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SYSTEM_SUPPORT_OS							<span class="comment">//如果SYSTEM_SUPPORT_OS定义了,说明要支持OS了(不限于UCOS).</span></span></span><br><span class="line"><span class="comment">//当delay_us/delay_ms需要支持OS的时候需要三个与OS相关的宏定义和函数来支持</span></span><br><span class="line"><span class="comment">//首先是3个宏定义:</span></span><br><span class="line"><span class="comment">//    delay_osrunning:用于表示OS当前是否正在运行,以决定是否可以使用相关函数</span></span><br><span class="line"><span class="comment">//delay_ostickspersec:用于表示OS设定的时钟节拍,delay_init将根据这个参数来初始哈systick</span></span><br><span class="line"><span class="comment">// delay_osintnesting:用于表示OS中断嵌套级别,因为中断里面不可以调度,delay_ms使用该参数来决定如何运行</span></span><br><span class="line"><span class="comment">//然后是3个函数:</span></span><br><span class="line"><span class="comment">//  delay_osschedlock:用于锁定OS任务调度,禁止调度</span></span><br><span class="line"><span class="comment">//delay_osschedunlock:用于解锁OS任务调度,重新开启调度</span></span><br><span class="line"><span class="comment">//    delay_ostimedly:用于OS延时,可以引起任务调度.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//本例程仅作UCOSII和UCOSIII的支持,其他OS,请自行参考着移植</span></span><br><span class="line"><span class="comment">//支持UCOSII</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> 	OS_CRITICAL_METHOD						<span class="comment">//OS_CRITICAL_METHOD定义了,说明要支持UCOSII				</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> delay_osrunning		OSRunning			<span class="comment">//OS是否运行标记,0,不运行;1,在运行</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> delay_ostickspersec	OS_TICKS_PER_SEC	<span class="comment">//OS时钟节拍,即每秒调度次数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> delay_osintnesting 	OSIntNesting		<span class="comment">//中断嵌套级别,即中断嵌套次数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//支持UCOSIII</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> 	CPU_CFG_CRITICAL_METHOD					<span class="comment">//CPU_CFG_CRITICAL_METHOD定义了,说明要支持UCOSIII	</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> delay_osrunning		OSRunning			<span class="comment">//OS是否运行标记,0,不运行;1,在运行</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> delay_ostickspersec	OSCfg_TickRate_Hz	<span class="comment">//OS时钟节拍,即每秒调度次数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> delay_osintnesting 	OSIntNestingCtr		<span class="comment">//中断嵌套级别,即中断嵌套次数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//us级延时时,关闭任务调度(防止打断us级延迟)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_osschedlock</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CPU_CFG_CRITICAL_METHOD   			<span class="comment">//使用UCOSIII</span></span></span><br><span class="line">	OS_ERR err; </span><br><span class="line">	OSSchedLock(&amp;err);						<span class="comment">//UCOSIII的方式,禁止调度，防止打断us延时</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span>										<span class="comment">//否则UCOSII</span></span></span><br><span class="line">	OSSchedLock();							<span class="comment">//UCOSII的方式,禁止调度，防止打断us延时</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//us级延时时,恢复任务调度</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_osschedunlock</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;	</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CPU_CFG_CRITICAL_METHOD   			<span class="comment">//使用UCOSIII</span></span></span><br><span class="line">	OS_ERR err; </span><br><span class="line">	OSSchedUnlock(&amp;err);					<span class="comment">//UCOSIII的方式,恢复调度</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span>										<span class="comment">//否则UCOSII</span></span></span><br><span class="line">	OSSchedUnlock();						<span class="comment">//UCOSII的方式,恢复调度</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用OS自带的延时函数延时</span></span><br><span class="line"><span class="comment">//ticks:延时的节拍数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ostimedly</span><span class="params">(u32 ticks)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CPU_CFG_CRITICAL_METHOD</span></span><br><span class="line">	OS_ERR err; </span><br><span class="line">	OSTimeDly(ticks,OS_OPT_TIME_PERIODIC,&amp;err);<span class="comment">//UCOSIII延时采用周期模式</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	OSTimeDly(ticks);						<span class="comment">//UCOSII延时</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//systick中断服务函数,使用OS时用到</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SysTick_Handler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;	</span><br><span class="line">	<span class="keyword">if</span>(delay_osrunning==<span class="number">1</span>)					<span class="comment">//OS开始跑了,才执行正常的调度处理</span></span><br><span class="line">	&#123;</span><br><span class="line">		OSIntEnter();						<span class="comment">//进入中断</span></span><br><span class="line">		OSTimeTick();       				<span class="comment">//调用ucos的时钟服务程序               </span></span><br><span class="line">		OSIntExit();       	 				<span class="comment">//触发任务切换软中断</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">			   </span><br><span class="line"><span class="comment">//初始化延迟函数</span></span><br><span class="line"><span class="comment">//当使用OS的时候,此函数会初始化OS的时钟节拍</span></span><br><span class="line"><span class="comment">//SYSTICK的时钟固定为HCLK时钟的1/8</span></span><br><span class="line"><span class="comment">//SYSCLK:系统时钟</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_init</span><span class="params">(u8 SYSCLK)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SYSTEM_SUPPORT_OS 						<span class="comment">//如果需要支持OS.</span></span></span><br><span class="line">	u32 reload;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"> 	SysTick-&gt;CTRL&amp;=~(<span class="number">1</span>&lt;&lt;<span class="number">2</span>);					<span class="comment">//SYSTICK使用外部时钟源	 </span></span><br><span class="line">	fac_us=SYSCLK/<span class="number">8</span>;						<span class="comment">//不论是否使用OS,fac_us都需要使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SYSTEM_SUPPORT_OS 						<span class="comment">//如果需要支持OS.</span></span></span><br><span class="line">	reload=SYSCLK/<span class="number">8</span>;						<span class="comment">//每秒钟的计数次数 单位为K	   </span></span><br><span class="line">	reload*=<span class="number">1000000</span>/delay_ostickspersec;	<span class="comment">//根据delay_ostickspersec设定溢出时间</span></span><br><span class="line">											<span class="comment">//reload为24位寄存器,最大值:16777216,在72M下,约合1.86s左右	</span></span><br><span class="line">	fac_ms=<span class="number">1000</span>/delay_ostickspersec;		<span class="comment">//代表OS可以延时的最少单位	   </span></span><br><span class="line">	SysTick-&gt;CTRL|=<span class="number">1</span>&lt;&lt;<span class="number">1</span>;   					<span class="comment">//开启SYSTICK中断</span></span><br><span class="line">	SysTick-&gt;LOAD=reload; 					<span class="comment">//每1/delay_ostickspersec秒中断一次	</span></span><br><span class="line">	SysTick-&gt;CTRL|=<span class="number">1</span>&lt;&lt;<span class="number">0</span>;   					<span class="comment">//开启SYSTICK    </span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	fac_ms=(u16)fac_us*<span class="number">1000</span>;				<span class="comment">//非OS下,代表每个ms需要的systick时钟数   </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;								    </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SYSTEM_SUPPORT_OS 						<span class="comment">//如果需要支持OS.</span></span></span><br><span class="line"><span class="comment">//延时nus</span></span><br><span class="line"><span class="comment">//nus为要延时的us数.		    								   </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(u32 nus)</span></span><br><span class="line">&#123;		</span><br><span class="line">	u32 ticks;</span><br><span class="line">	u32 told,tnow,tcnt=<span class="number">0</span>;</span><br><span class="line">	u32 reload=SysTick-&gt;LOAD;				<span class="comment">//LOAD的值	    	 </span></span><br><span class="line">	ticks=nus*fac_us; 						<span class="comment">//需要的节拍数 </span></span><br><span class="line">	delay_osschedlock();					<span class="comment">//阻止OS调度，防止打断us延时</span></span><br><span class="line">	told=SysTick-&gt;VAL;        				<span class="comment">//刚进入时的计数器值</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		tnow=SysTick-&gt;VAL;	</span><br><span class="line">		<span class="keyword">if</span>(tnow!=told)</span><br><span class="line">		&#123;	    </span><br><span class="line">			<span class="keyword">if</span>(tnow&lt;told)tcnt+=told-tnow;	<span class="comment">//这里注意一下SYSTICK是一个递减的计数器就可以了.</span></span><br><span class="line">			<span class="keyword">else</span> tcnt+=reload-tnow+told;	    </span><br><span class="line">			told=tnow;</span><br><span class="line">			<span class="keyword">if</span>(tcnt&gt;=ticks)<span class="keyword">break</span>;			<span class="comment">//时间超过/等于要延迟的时间,则退出.</span></span><br><span class="line">		&#125;  </span><br><span class="line">	&#125;;</span><br><span class="line">	delay_osschedunlock();					<span class="comment">//恢复OS调度									    </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//延时nms</span></span><br><span class="line"><span class="comment">//nms:要延时的ms数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(u16 nms)</span></span><br><span class="line">&#123;	</span><br><span class="line">	<span class="keyword">if</span>(delay_osrunning&amp;&amp;delay_osintnesting==<span class="number">0</span>)<span class="comment">//如果OS已经在跑了,并且不是在中断里面(中断里面不能任务调度)	    </span></span><br><span class="line">	&#123;		 </span><br><span class="line">		<span class="keyword">if</span>(nms&gt;=fac_ms)						<span class="comment">//延时的时间大于OS的最少时间周期 </span></span><br><span class="line">		&#123; </span><br><span class="line">   			delay_ostimedly(nms/fac_ms);	<span class="comment">//OS延时</span></span><br><span class="line">		&#125;</span><br><span class="line">		nms%=fac_ms;						<span class="comment">//OS已经无法提供这么小的延时了,采用普通方式延时    </span></span><br><span class="line">	&#125;</span><br><span class="line">	delay_us((u32)(nms*<span class="number">1000</span>));				<span class="comment">//普通方式延时  </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">//不用OS时</span></span></span><br><span class="line"><span class="comment">//延时nus</span></span><br><span class="line"><span class="comment">//nus为要延时的us数.		    								   </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(u32 nus)</span></span><br><span class="line">&#123;		</span><br><span class="line">	u32 temp;	    	 </span><br><span class="line">	SysTick-&gt;LOAD=nus*fac_us; 				<span class="comment">//时间加载	  		 </span></span><br><span class="line">	SysTick-&gt;VAL=<span class="number">0x00</span>;        				<span class="comment">//清空计数器</span></span><br><span class="line">	SysTick-&gt;CTRL=<span class="number">0x01</span> ;      				<span class="comment">//开始倒数 	 </span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		temp=SysTick-&gt;CTRL;</span><br><span class="line">	&#125;<span class="keyword">while</span>((temp&amp;<span class="number">0x01</span>)&amp;&amp;!(temp&amp;(<span class="number">1</span>&lt;&lt;<span class="number">16</span>)));	<span class="comment">//等待时间到达   </span></span><br><span class="line">	SysTick-&gt;CTRL=<span class="number">0x00</span>;      	 			<span class="comment">//关闭计数器</span></span><br><span class="line">	SysTick-&gt;VAL =<span class="number">0X00</span>;       				<span class="comment">//清空计数器	 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//延时nms</span></span><br><span class="line"><span class="comment">//注意nms的范围</span></span><br><span class="line"><span class="comment">//SysTick-&gt;LOAD为24位寄存器,所以,最大延时为:</span></span><br><span class="line"><span class="comment">//nms&lt;=0xffffff*8*1000/SYSCLK</span></span><br><span class="line"><span class="comment">//SYSCLK单位为Hz,nms单位为ms</span></span><br><span class="line"><span class="comment">//对72M条件下,nms&lt;=1864 </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(u16 nms)</span></span><br><span class="line">&#123;	 		  	  </span><br><span class="line">	u32 temp;		   </span><br><span class="line">	SysTick-&gt;LOAD=(u32)nms*fac_ms;			<span class="comment">//时间加载(SysTick-&gt;LOAD为24bit)</span></span><br><span class="line">	SysTick-&gt;VAL =<span class="number">0x00</span>;           			<span class="comment">//清空计数器</span></span><br><span class="line">	SysTick-&gt;CTRL=<span class="number">0x01</span> ;          			<span class="comment">//开始倒数  </span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		temp=SysTick-&gt;CTRL;</span><br><span class="line">	&#125;<span class="keyword">while</span>((temp&amp;<span class="number">0x01</span>)&amp;&amp;!(temp&amp;(<span class="number">1</span>&lt;&lt;<span class="number">16</span>)));	<span class="comment">//等待时间到达   </span></span><br><span class="line">	SysTick-&gt;CTRL=<span class="number">0x00</span>;      	 			<span class="comment">//关闭计数器</span></span><br><span class="line">	SysTick-&gt;VAL =<span class="number">0X00</span>;       				<span class="comment">//清空计数器	  	    </span></span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="delay.h">delay.h</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __DELAY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __DELAY_H 			   </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span>  </span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//使用SysTick的普通计数模式对延迟进行管理（适合STM32F10x系列）</span></span><br><span class="line"><span class="comment">//包括delay_us,delay_ms</span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//创建日期:2010/1/1</span></span><br><span class="line"><span class="comment">//版本：V1.8</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved</span></span><br><span class="line"><span class="comment">//********************************************************************************</span></span><br><span class="line"><span class="comment">//V1.2修改说明</span></span><br><span class="line"><span class="comment">//修正了中断中调用出现死循环的错误</span></span><br><span class="line"><span class="comment">//防止延时不准确,采用do while结构!</span></span><br><span class="line"><span class="comment">//V1.3修改说明</span></span><br><span class="line"><span class="comment">//增加了对UCOSII延时的支持.</span></span><br><span class="line"><span class="comment">//如果使用ucosII,delay_init会自动设置SYSTICK的值,使之与ucos的TICKS_PER_SEC对应.</span></span><br><span class="line"><span class="comment">//delay_ms和delay_us也进行了针对ucos的改造.</span></span><br><span class="line"><span class="comment">//delay_us可以在ucos下使用,而且准确度很高,更重要的是没有占用额外的定时器.</span></span><br><span class="line"><span class="comment">//delay_ms在ucos下,可以当成OSTimeDly来用,在未启动ucos时,它采用delay_us实现,从而准确延时</span></span><br><span class="line"><span class="comment">//可以用来初始化外设,在启动了ucos之后delay_ms根据延时的长短,选择OSTimeDly实现或者delay_us实现.</span></span><br><span class="line"><span class="comment">//V1.4修改说明 20110929</span></span><br><span class="line"><span class="comment">//修改了使用ucos,但是ucos未启动的时候,delay_ms中中断无法响应的bug.</span></span><br><span class="line"><span class="comment">//V1.5修改说明 20120902</span></span><br><span class="line"><span class="comment">//在delay_us加入ucos上锁，防止由于ucos打断delay_us的执行，可能导致的延时不准。</span></span><br><span class="line"><span class="comment">//V1.6修改说明 20150109</span></span><br><span class="line"><span class="comment">//在delay_ms加入OSLockNesting判断。</span></span><br><span class="line"><span class="comment">//V1.7修改说明 20150319</span></span><br><span class="line"><span class="comment">//修改OS支持方式,以支持任意OS(不限于UCOSII和UCOSIII,理论上任意OS都可以支持)</span></span><br><span class="line"><span class="comment">//添加:delay_osrunning/delay_ostickspersec/delay_osintnesting三个宏定义</span></span><br><span class="line"><span class="comment">//添加:delay_osschedlock/delay_osschedunlock/delay_ostimedly三个函数</span></span><br><span class="line"><span class="comment">//V1.8修改说明 20150519</span></span><br><span class="line"><span class="comment">//修正UCOSIII支持时的2个bug：</span></span><br><span class="line"><span class="comment">//delay_tickspersec改为：delay_ostickspersec</span></span><br><span class="line"><span class="comment">//delay_intnesting改为：delay_osintnesting</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_init</span><span class="params">(u8 SYSCLK)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(u16 nms)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_us</span><span class="params">(u32 nus)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="hc05">hc05</h2>
<h3 id="hc05.c">hc05.c</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;delay.h&quot;</span> 			 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usart.h&quot;</span> 			 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usart2.h&quot;</span> 			 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hc05.h&quot;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;led.h&quot;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span>	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;math.h&quot;</span></span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//ATK-HC05蓝牙模块驱动代码	   </span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//修改日期:2014/3/29</span></span><br><span class="line"><span class="comment">//版本：V1.1</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved									  </span></span><br><span class="line"><span class="comment">//********************************************************************************</span></span><br><span class="line"><span class="comment">//V1.1 20140329</span></span><br><span class="line"><span class="comment">//修改LED的连接，原来接PC5，改为PA4，以兼容MiniSTM32开发板V3.0									  </span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化ATK-HC05模块</span></span><br><span class="line"><span class="comment">//返回值:0,成功;1,失败.</span></span><br><span class="line">u8 <span class="title function_">HC05_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">		 </span><br><span class="line">	u8 temp=<span class="number">0</span>;</span><br><span class="line">	RCC-&gt;APB2ENR|=<span class="number">1</span>&lt;&lt;<span class="number">2</span>;    	<span class="comment">//使能PORTA时钟	 	</span></span><br><span class="line">	RCC-&gt;APB2ENR|=<span class="number">1</span>&lt;&lt;<span class="number">4</span>;    	<span class="comment">//使能PORTC时钟	 	</span></span><br><span class="line"> 	GPIOA-&gt;CRL&amp;=<span class="number">0XFFF0FFFF</span>;	<span class="comment">//PA4,输入</span></span><br><span class="line"> 	GPIOA-&gt;CRL|=<span class="number">0X00080000</span>; </span><br><span class="line">	GPIOA-&gt;ODR|=<span class="number">1</span>&lt;&lt;<span class="number">4</span>; 		<span class="comment">//PA4上拉 </span></span><br><span class="line">	GPIOC-&gt;CRL&amp;=<span class="number">0XFFF0FFFF</span>;	<span class="comment">//PC4,推挽输出</span></span><br><span class="line">	GPIOC-&gt;CRL|=<span class="number">0X00030000</span>; </span><br><span class="line">	GPIOC-&gt;ODR|=<span class="number">1</span>&lt;&lt;<span class="number">4</span>; 		<span class="comment">//PC4输出1	</span></span><br><span class="line">	USART2_Init(<span class="number">36</span>,<span class="number">115200</span>);	<span class="comment">//初始化串口2为:9600,波特率.</span></span><br><span class="line">	<span class="keyword">return</span> temp;	 </span><br><span class="line">&#125;	 </span><br><span class="line"><span class="comment">//获取ATK-HC05模块的角色</span></span><br><span class="line"><span class="comment">//返回值:0,从机;1,主机;0XFF,获取失败.							  </span></span><br><span class="line">u8 <span class="title function_">HC05_Get_Role</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;	 		    </span><br><span class="line">	u8 retry=<span class="number">0X0F</span>;</span><br><span class="line">	u8 temp,t;</span><br><span class="line">	<span class="keyword">while</span>(retry--)</span><br><span class="line">	&#123;</span><br><span class="line">		HC05_KEY=<span class="number">1</span>;					<span class="comment">//KEY置高,进入AT模式</span></span><br><span class="line">		delay_ms(<span class="number">10</span>);</span><br><span class="line">		u2_printf(<span class="string">&quot;AT+ROLE?\r\n&quot;</span>);	<span class="comment">//查询角色</span></span><br><span class="line">		<span class="keyword">for</span>(t=<span class="number">0</span>;t&lt;<span class="number">20</span>;t++) 			<span class="comment">//最长等待200ms,来接收HC05模块的回应</span></span><br><span class="line">		&#123;</span><br><span class="line">			delay_ms(<span class="number">10</span>);</span><br><span class="line">			<span class="keyword">if</span>(USART2_RX_STA&amp;<span class="number">0X8000</span>)<span class="keyword">break</span>;</span><br><span class="line">		&#125;		</span><br><span class="line">		HC05_KEY=<span class="number">0</span>;					<span class="comment">//KEY拉低,退出AT模式</span></span><br><span class="line">		<span class="keyword">if</span>(USART2_RX_STA&amp;<span class="number">0X8000</span>)	<span class="comment">//接收到一次数据了</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp=USART2_RX_STA&amp;<span class="number">0X7FFF</span>;	<span class="comment">//得到数据长度</span></span><br><span class="line">			USART2_RX_STA=<span class="number">0</span>;			 </span><br><span class="line">			<span class="keyword">if</span>(temp==<span class="number">13</span>&amp;&amp;USART2_RX_BUF[<span class="number">0</span>]==<span class="string">&#x27;+&#x27;</span>)<span class="comment">//接收到正确的应答了</span></span><br><span class="line">			&#123;</span><br><span class="line">				temp=USART2_RX_BUF[<span class="number">6</span>]-<span class="string">&#x27;0&#x27;</span>;<span class="comment">//得到主从模式值</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(retry==<span class="number">0</span>)temp=<span class="number">0XFF</span>;<span class="comment">//查询失败.</span></span><br><span class="line">	<span class="keyword">return</span> temp;</span><br><span class="line">&#125; 							   </span><br><span class="line"><span class="comment">//ATK-HC05设置命令</span></span><br><span class="line"><span class="comment">//此函数用于设置ATK-HC05,适用于仅返回OK应答的AT指令</span></span><br><span class="line"><span class="comment">//atstr:AT指令串.比如:&quot;AT+RESET&quot;/&quot;AT+UART=9600,0,0&quot;/&quot;AT+ROLE=0&quot;等字符串</span></span><br><span class="line"><span class="comment">//返回值:0,设置成功;其他,设置失败.							  </span></span><br><span class="line">u8 <span class="title function_">HC05_Set_Cmd</span><span class="params">(u8* atstr)</span></span><br><span class="line">&#123;	 		    </span><br><span class="line">	u8 retry=<span class="number">0X0F</span>;</span><br><span class="line">	u8 temp,t;</span><br><span class="line">	<span class="keyword">while</span>(retry--)</span><br><span class="line">	&#123;</span><br><span class="line">		HC05_KEY=<span class="number">1</span>;					<span class="comment">//KEY置高,进入AT模式</span></span><br><span class="line">		delay_ms(<span class="number">10</span>);</span><br><span class="line">		u2_printf(<span class="string">&quot;%s\r\n&quot;</span>,atstr);	<span class="comment">//发送AT字符串</span></span><br><span class="line">		HC05_KEY=<span class="number">0</span>;					<span class="comment">//KEY拉低,退出AT模式</span></span><br><span class="line">		<span class="keyword">for</span>(t=<span class="number">0</span>;t&lt;<span class="number">20</span>;t++) 			<span class="comment">//最长等待100ms,来接收HC05模块的回应</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(USART2_RX_STA&amp;<span class="number">0X8000</span>)<span class="keyword">break</span>;</span><br><span class="line">			delay_ms(<span class="number">5</span>);</span><br><span class="line">		&#125;		</span><br><span class="line">		<span class="keyword">if</span>(USART2_RX_STA&amp;<span class="number">0X8000</span>)	<span class="comment">//接收到一次数据了</span></span><br><span class="line">		&#123;</span><br><span class="line">			temp=USART2_RX_STA&amp;<span class="number">0X7FFF</span>;	<span class="comment">//得到数据长度</span></span><br><span class="line">			USART2_RX_STA=<span class="number">0</span>;			 </span><br><span class="line">			<span class="keyword">if</span>(temp==<span class="number">4</span>&amp;&amp;USART2_RX_BUF[<span class="number">0</span>]==<span class="string">&#x27;O&#x27;</span>)<span class="comment">//接收到正确的应答了</span></span><br><span class="line">			&#123;			</span><br><span class="line">				temp=<span class="number">0</span>;</span><br><span class="line">				<span class="keyword">break</span>;			 </span><br><span class="line">			&#125;</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(retry==<span class="number">0</span>)temp=<span class="number">0XFF</span>;<span class="comment">//设置失败.</span></span><br><span class="line">	<span class="keyword">return</span> temp;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//通过该函数,可以利用USMART,调试接在串口2上的ATK-HC05模块</span></span><br><span class="line"><span class="comment">//str:命令串.(这里注意不再需要再输入回车符)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HC05_CFG_CMD</span><span class="params">(u8 *str)</span></span><br><span class="line">&#123;					  </span><br><span class="line">	u8 temp;</span><br><span class="line">	u8 t;		  </span><br><span class="line">	HC05_KEY=<span class="number">1</span>;						<span class="comment">//KEY置高,进入AT模式</span></span><br><span class="line">	delay_ms(<span class="number">10</span>);</span><br><span class="line">	u2_printf(<span class="string">&quot;%s\r\n&quot;</span>,(<span class="type">char</span>*)str); <span class="comment">//发送指令</span></span><br><span class="line">	<span class="keyword">for</span>(t=<span class="number">0</span>;t&lt;<span class="number">50</span>;t++) 				<span class="comment">//最长等待500ms,来接收HC05模块的回应</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(USART2_RX_STA&amp;<span class="number">0X8000</span>)<span class="keyword">break</span>;</span><br><span class="line">		delay_ms(<span class="number">10</span>);</span><br><span class="line">	&#125;									    </span><br><span class="line">	HC05_KEY=<span class="number">0</span>;						<span class="comment">//KEY拉低,退出AT模式</span></span><br><span class="line">	<span class="keyword">if</span>(USART2_RX_STA&amp;<span class="number">0X8000</span>)		<span class="comment">//接收到一次数据了</span></span><br><span class="line">	&#123;</span><br><span class="line">		temp=USART2_RX_STA&amp;<span class="number">0X7FFF</span>;	<span class="comment">//得到数据长度</span></span><br><span class="line">		USART2_RX_STA=<span class="number">0</span>;</span><br><span class="line">		USART2_RX_BUF[temp]=<span class="number">0</span>;		<span class="comment">//加结束符		 </span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\r\n%s&quot;</span>,USART2_RX_BUF);<span class="comment">//发送回应数据到串口1</span></span><br><span class="line">	&#125; 				 </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="hc05.h">hc05.h</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __HC05_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __HC05_H	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span> </span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//ATK-HC05蓝牙模块驱动代码	   </span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//修改日期:2014/3/29</span></span><br><span class="line"><span class="comment">//版本：V1.1</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved									  </span></span><br><span class="line"><span class="comment">//********************************************************************************</span></span><br><span class="line"><span class="comment">//V1.1 20140329</span></span><br><span class="line"><span class="comment">//修改LED的连接，原来接PC5，改为PA4，以兼容MiniSTM32开发板V3.0									  </span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////   </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HC05_KEY  	PCout(4) 	<span class="comment">//蓝牙控制KEY信号</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HC05_LED  	PAin(4)		<span class="comment">//蓝牙连接状态信号</span></span></span><br><span class="line">  </span><br><span class="line">u8 <span class="title function_">HC05_Init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">HC05_CFG_CMD</span><span class="params">(u8 *str)</span>;</span><br><span class="line">u8 <span class="title function_">HC05_Get_Role</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">u8 <span class="title function_">HC05_Set_Cmd</span><span class="params">(u8* atstr)</span>;	   </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="usart2">usart2</h2>
<h3 id="usart2.c">usart2.c</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usart2.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdarg.h&quot;</span>	 	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span>	 	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span>	   </span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//串口2驱动代码	   </span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//修改日期:2014/3/29</span></span><br><span class="line"><span class="comment">//版本：V1.0</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved									  </span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	   </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//串口发送缓存区 	</span></span><br><span class="line">__align(<span class="number">8</span>) u8 USART2_TX_BUF[USART2_MAX_SEND_LEN]; 	<span class="comment">//发送缓冲,最大USART2_MAX_SEND_LEN字节</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> USART2_RX_EN   								<span class="comment">//如果使能了接收   	  </span></span></span><br><span class="line"><span class="comment">//串口接收缓存区 	</span></span><br><span class="line">u8 USART2_RX_BUF[USART2_MAX_RECV_LEN]; 				<span class="comment">//接收缓冲,最大USART2_MAX_RECV_LEN个字节.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//通过判断接收连续2个字符之间的时间差不大于10ms来决定是不是一次连续的数据.</span></span><br><span class="line"><span class="comment">//如果2个字符接收间隔超过10ms,则认为不是1次连续数据.也就是超过10ms没有接收到</span></span><br><span class="line"><span class="comment">//任何数据,则表示此次接收完毕.</span></span><br><span class="line"><span class="comment">//接收到的数据状态</span></span><br><span class="line"><span class="comment">//[15]:0,没有接收到数据;1,接收到了一批数据.</span></span><br><span class="line"><span class="comment">//[14:0]:接收到的数据长度</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化IO 串口2</span></span><br><span class="line"><span class="comment">//pclk1:PCLK1时钟频率(Mhz)</span></span><br><span class="line"><span class="comment">//bound:波特率	  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">USART2_Init</span><span class="params">(u32 pclk1,u32 bound)</span></span><br><span class="line">&#123;  	 		 </span><br><span class="line">	RCC-&gt;APB2ENR|=<span class="number">1</span>&lt;&lt;<span class="number">2</span>;   	<span class="comment">//使能PORTA口时钟  </span></span><br><span class="line">	GPIOA-&gt;CRL&amp;=<span class="number">0XFFFF00FF</span>;	<span class="comment">//IO状态设置</span></span><br><span class="line">	GPIOA-&gt;CRL|=<span class="number">0X00008B00</span>;	<span class="comment">//IO状态设置	 </span></span><br><span class="line">	RCC-&gt;APB1ENR|=<span class="number">1</span>&lt;&lt;<span class="number">17</span>;  	<span class="comment">//使能串口时钟 	 </span></span><br><span class="line">	RCC-&gt;APB1RSTR|=<span class="number">1</span>&lt;&lt;<span class="number">17</span>;   <span class="comment">//复位串口2</span></span><br><span class="line">	RCC-&gt;APB1RSTR&amp;=~(<span class="number">1</span>&lt;&lt;<span class="number">17</span>);<span class="comment">//停止复位	   	   </span></span><br><span class="line">	<span class="comment">//波特率设置</span></span><br><span class="line"> 	USART2-&gt;BRR=(pclk1*<span class="number">1000000</span>)/(bound);<span class="comment">// 波特率设置	 </span></span><br><span class="line">	USART2-&gt;CR1|=<span class="number">0X200C</span>;  	<span class="comment">//1位停止,无校验位.</span></span><br><span class="line">	USART2-&gt;CR3=<span class="number">1</span>&lt;&lt;<span class="number">7</span>;   	<span class="comment">//使能串口2的DMA发送</span></span><br><span class="line">	UART_DMA_Config(DMA1_Channel7,(u32)&amp;USART2-&gt;DR,(u32)USART2_TX_BUF);<span class="comment">//DMA1通道7,外设为串口2,存储器为USART2_TX_BUF </span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> USART2_RX_EN		  	<span class="comment">//如果使能了接收</span></span></span><br><span class="line">	<span class="comment">//使能接收中断</span></span><br><span class="line">	USART2-&gt;CR1|=<span class="number">1</span>&lt;&lt;<span class="number">8</span>;    	<span class="comment">//PE中断使能</span></span><br><span class="line">	USART2-&gt;CR1|=<span class="number">1</span>&lt;&lt;<span class="number">5</span>;    	<span class="comment">//接收缓冲区非空中断使能	    	</span></span><br><span class="line">	MY_NVIC_Init(<span class="number">2</span>,<span class="number">3</span>,USART2_IRQn,<span class="number">4</span>);<span class="comment">//组4，最高优先级 </span></span><br><span class="line">	TIM4_Init(<span class="number">99</span>,<span class="number">7199</span>);		<span class="comment">//10ms中断</span></span><br><span class="line">	USART2_RX_STA=<span class="number">0</span>;		<span class="comment">//清零</span></span><br><span class="line">	TIM4_Set(<span class="number">0</span>);			<span class="comment">//关闭定时器4</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>										  	</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//串口2,printf 函数</span></span><br><span class="line"><span class="comment">//确保一次发送数据不超过USART2_MAX_SEND_LEN字节</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">u2_printf</span><span class="params">(<span class="type">char</span>* fmt,...)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">	va_list ap;</span><br><span class="line">	va_start(ap,fmt);</span><br><span class="line">	<span class="built_in">vsprintf</span>((<span class="type">char</span>*)USART2_TX_BUF,fmt,ap);</span><br><span class="line">	va_end(ap);</span><br><span class="line">	<span class="keyword">while</span>(DMA1_Channel7-&gt;CNDTR!=<span class="number">0</span>);	<span class="comment">//等待通道7传输完成   </span></span><br><span class="line">	UART_DMA_Enable(DMA1_Channel7,<span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span>*)USART2_TX_BUF)); 	<span class="comment">//通过dma发送出去</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//定时器4中断服务程序		    </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">TIM4_IRQHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123; 	</span><br><span class="line">	<span class="keyword">if</span>(TIM4-&gt;SR&amp;<span class="number">0X01</span>)<span class="comment">//是更新中断</span></span><br><span class="line">	&#123;	 			   </span><br><span class="line">		USART2_RX_STA|=<span class="number">1</span>&lt;&lt;<span class="number">15</span>;	<span class="comment">//标记接收完成</span></span><br><span class="line">		TIM4-&gt;SR&amp;=~(<span class="number">1</span>&lt;&lt;<span class="number">0</span>);		<span class="comment">//清除中断标志位		   </span></span><br><span class="line">		TIM4_Set(<span class="number">0</span>);			<span class="comment">//关闭TIM4  </span></span><br><span class="line">	&#125;	    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//设置TIM4的开关</span></span><br><span class="line"><span class="comment">//sta:0，关闭;1,开启;</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">TIM4_Set</span><span class="params">(u8 sta)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(sta)</span><br><span class="line">	&#123;</span><br><span class="line">    	TIM4-&gt;CNT=<span class="number">0</span>;         <span class="comment">//计数器清空</span></span><br><span class="line">		TIM4-&gt;CR1|=<span class="number">1</span>&lt;&lt;<span class="number">0</span>;     <span class="comment">//使能定时器4</span></span><br><span class="line">	&#125;<span class="keyword">else</span> TIM4-&gt;CR1&amp;=~(<span class="number">1</span>&lt;&lt;<span class="number">0</span>);<span class="comment">//关闭定时器4	   </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//通用定时器中断初始化</span></span><br><span class="line"><span class="comment">//这里始终选择为APB1的2倍，而APB1为36M</span></span><br><span class="line"><span class="comment">//arr：自动重装值。</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数		 </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">TIM4_Init</span><span class="params">(u16 arr,u16 psc)</span></span><br><span class="line">&#123;</span><br><span class="line">	RCC-&gt;APB1ENR|=<span class="number">1</span>&lt;&lt;<span class="number">2</span>;	<span class="comment">//TIM4时钟使能    </span></span><br><span class="line"> 	TIM4-&gt;ARR=arr;  	<span class="comment">//设定计数器自动重装值   </span></span><br><span class="line">	TIM4-&gt;PSC=psc;  	<span class="comment">//预分频器</span></span><br><span class="line"> 	TIM4-&gt;DIER|=<span class="number">1</span>&lt;&lt;<span class="number">0</span>;   <span class="comment">//允许更新中断				</span></span><br><span class="line"> 	TIM4-&gt;CR1|=<span class="number">0x01</span>;  	<span class="comment">//使能定时器4	  	   </span></span><br><span class="line">   	MY_NVIC_Init(<span class="number">1</span>,<span class="number">3</span>,TIM4_IRQn,<span class="number">2</span>);<span class="comment">//抢占2，子优先级3，组2	在2中优先级最低								 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>		 </span></span><br><span class="line"><span class="comment">///////////////////////////////////////USART2 DMA发送配置部分//////////////////////////////////	   		    </span></span><br><span class="line"><span class="comment">//DMA1的各通道配置</span></span><br><span class="line"><span class="comment">//这里的传输形式是固定的,这点要根据不同的情况来修改</span></span><br><span class="line"><span class="comment">//从存储器-&gt;外设模式/8位数据宽度/存储器增量模式</span></span><br><span class="line"><span class="comment">//DMA_CHx:DMA通道CHx</span></span><br><span class="line"><span class="comment">//cpar:外设地址</span></span><br><span class="line"><span class="comment">//cmar:存储器地址    </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_DMA_Config</span><span class="params">(DMA_Channel_TypeDef*DMA_CHx,u32 cpar,u32 cmar)</span></span><br><span class="line">&#123;</span><br><span class="line"> 	RCC-&gt;AHBENR|=<span class="number">1</span>&lt;&lt;<span class="number">0</span>;			<span class="comment">//开启DMA1时钟</span></span><br><span class="line">	delay_us(<span class="number">5</span>);</span><br><span class="line">	DMA_CHx-&gt;CPAR=cpar; 		<span class="comment">//DMA1 外设地址 </span></span><br><span class="line">	DMA_CHx-&gt;CMAR=cmar; 		<span class="comment">//DMA1,存储器地址	 </span></span><br><span class="line">	DMA_CHx-&gt;CCR=<span class="number">0X00000000</span>;	<span class="comment">//复位</span></span><br><span class="line">	DMA_CHx-&gt;CCR|=<span class="number">1</span>&lt;&lt;<span class="number">4</span>;  		<span class="comment">//从存储器读</span></span><br><span class="line">	DMA_CHx-&gt;CCR|=<span class="number">0</span>&lt;&lt;<span class="number">5</span>;  		<span class="comment">//普通模式</span></span><br><span class="line">	DMA_CHx-&gt;CCR|=<span class="number">0</span>&lt;&lt;<span class="number">6</span>;  		<span class="comment">//外设地址非增量模式</span></span><br><span class="line">	DMA_CHx-&gt;CCR|=<span class="number">1</span>&lt;&lt;<span class="number">7</span>;  		<span class="comment">//存储器增量模式</span></span><br><span class="line">	DMA_CHx-&gt;CCR|=<span class="number">0</span>&lt;&lt;<span class="number">8</span>;  		<span class="comment">//外设数据宽度为8位</span></span><br><span class="line">	DMA_CHx-&gt;CCR|=<span class="number">0</span>&lt;&lt;<span class="number">10</span>; 		<span class="comment">//存储器数据宽度8位</span></span><br><span class="line">	DMA_CHx-&gt;CCR|=<span class="number">1</span>&lt;&lt;<span class="number">12</span>; 		<span class="comment">//中等优先级</span></span><br><span class="line">	DMA_CHx-&gt;CCR|=<span class="number">0</span>&lt;&lt;<span class="number">14</span>; 		<span class="comment">//非存储器到存储器模式		  	</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//开启一次DMA传输</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_DMA_Enable</span><span class="params">(DMA_Channel_TypeDef*DMA_CHx,u16 len)</span></span><br><span class="line">&#123;</span><br><span class="line">	DMA_CHx-&gt;CCR&amp;=~(<span class="number">1</span>&lt;&lt;<span class="number">0</span>);       <span class="comment">//关闭DMA传输 </span></span><br><span class="line">	DMA_CHx-&gt;CNDTR=len;          <span class="comment">//DMA1,传输数据量 </span></span><br><span class="line">	DMA_CHx-&gt;CCR|=<span class="number">1</span>&lt;&lt;<span class="number">0</span>;          <span class="comment">//开启DMA传输</span></span><br><span class="line">&#125;	   </span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 									 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="usart2.h">usart2.h</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __USART2_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __USART2_H	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys.h&quot;</span>  </span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////	 </span></span><br><span class="line"><span class="comment">//本程序只供学习使用，未经作者许可，不得用于其它任何用途</span></span><br><span class="line"><span class="comment">//ALIENTEK STM32开发板</span></span><br><span class="line"><span class="comment">//串口2驱动代码	   </span></span><br><span class="line"><span class="comment">//正点原子@ALIENTEK</span></span><br><span class="line"><span class="comment">//技术论坛:www.openedv.com</span></span><br><span class="line"><span class="comment">//修改日期:2014/3/29</span></span><br><span class="line"><span class="comment">//版本：V1.0</span></span><br><span class="line"><span class="comment">//版权所有，盗版必究。</span></span><br><span class="line"><span class="comment">//Copyright(C) 广州市星翼电子科技有限公司 2009-2019</span></span><br><span class="line"><span class="comment">//All rights reserved									  </span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	   </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USART2_MAX_RECV_LEN		200					<span class="comment">//最大接收缓存字节数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USART2_MAX_SEND_LEN		200					<span class="comment">//最大发送缓存字节数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USART2_RX_EN 			1					<span class="comment">//0,不接收;1,接收.</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> g_usart2_flag ;</span><br><span class="line"><span class="keyword">extern</span> u8  USART2_RX_BUF[USART2_MAX_RECV_LEN]; 		<span class="comment">//接收缓冲,最大USART2_MAX_RECV_LEN字节</span></span><br><span class="line"><span class="keyword">extern</span> u8  USART2_TX_BUF[USART2_MAX_SEND_LEN]; 		<span class="comment">//发送缓冲,最大USART2_MAX_SEND_LEN字节</span></span><br><span class="line"><span class="keyword">extern</span> u16 USART2_RX_STA;   						<span class="comment">//接收数据状态</span></span><br><span class="line"><span class="keyword">extern</span> u16 USART2_RX_STA;</span><br><span class="line"><span class="type">void</span> <span class="title function_">USART2_Init</span><span class="params">(u32 pclk2,u32 bound)</span>;				<span class="comment">//串口2初始化 </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">TIM4_Set</span><span class="params">(u8 sta)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">TIM4_Init</span><span class="params">(u16 arr,u16 psc)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_DMA_Config</span><span class="params">(DMA_Channel_TypeDef*DMA_CHx,u32 cpar,u32 cmar)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">UART_DMA_Enable</span><span class="params">(DMA_Channel_TypeDef*DMA_CHx,u16 len)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">u2_printf</span><span class="params">(<span class="type">char</span>* fmt, ...)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Center-cr</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/04/25/%E5%8D%95%E7%89%87%E6%9C%BA/HC05%E8%93%9D%E7%89%99%E6%8E%A7%E5%88%B6%E7%88%AC%E8%A1%8C%E6%9C%BA%E5%99%A8%E4%BA%BA/">http://example.com/2023/04/25/%E5%8D%95%E7%89%87%E6%9C%BA/HC05%E8%93%9D%E7%89%99%E6%8E%A7%E5%88%B6%E7%88%AC%E8%A1%8C%E6%9C%BA%E5%99%A8%E4%BA%BA/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Center-cr's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/hc05/">hc05</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/Center-cr/picture/main/202307091524065.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/28/%E7%89%A9%E8%81%94%E7%BD%91%E9%A1%B9%E7%9B%AE/MQTT/" title="MQTT协议+docker访问HA"><img class="cover" src="https://raw.githubusercontent.com/Center-cr/picture/main/202307091527887.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MQTT协议+docker访问HA</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/25/%E8%BD%AF%E4%BB%B6%E7%BC%96%E7%A8%8B/C#/%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/" title="学生信息管理系统"><img class="cover" src="https://raw.githubusercontent.com/Center-cr/picture/main/202307091520080.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">学生信息管理系统</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E8%BF%9B%E8%A1%8Cat%E6%8C%87%E4%BB%A4%E8%B0%83%E6%95%B4%E6%B3%A2%E7%89%B9%E7%8E%87"><span class="toc-text">首先进行AT指令调整波特率</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main"><span class="toc-text">main</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sys"><span class="toc-text">sys</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sys.c"><span class="toc-text">sys.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sys.h"><span class="toc-text">sys.h</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usart"><span class="toc-text">usart</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#usart.c"><span class="toc-text">usart.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#usart.h"><span class="toc-text">usart.h</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#delay"><span class="toc-text">delay</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#delay.c"><span class="toc-text">delay.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delay.h"><span class="toc-text">delay.h</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hc05"><span class="toc-text">hc05</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hc05.c"><span class="toc-text">hc05.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hc05.h"><span class="toc-text">hc05.h</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usart2"><span class="toc-text">usart2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#usart2.c"><span class="toc-text">usart2.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#usart2.h"><span class="toc-text">usart2.h</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://raw.githubusercontent.com/Center-cr/picture/main/202307091524065.png')"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/instant.page/instantpage.js" type="module"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '0b46f2c6ec014d6d94b7',
      clientSecret: '2898008e1b0c5fc2a1119c65b2ef15dd09826304',
      repo: 'Center-cr.github.io',
      owner: 'Center-cr',
      admin: ['Center-cr'],
      id: '9fcc6c5b4dc54d454965839227dd9ca0',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('/pluginsSrc/gitalk/dist/gitalk.css')
    getScript('/pluginsSrc/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><div class="aplayer no-destroy" data-id="8611176905" data-server="netease" data-type="playlist" data-fixed="false" data-autoplay="false"> </div><script async data-pjax src="/js/random.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="/pluginsSrc/butterfly-extsrc/dist/fireworks.min.js"></script><link rel="stylesheet" href="/pluginsSrc/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/aplayer/dist/APlayer.min.js"></script><script src="/pluginsSrc/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>